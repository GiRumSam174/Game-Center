<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Center v8.4</title>
    <meta name="theme-color" content="#222">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg-color: #222; --text-color: white; --accent-p2p: #8a2be2;
            --bs-water: #004488; --bs-ship: #777777; --bs-hit: #cc3300; --bs-miss: #ffffff;
            --grav-board: #004488; --grav-p1: #ff3333; --grav-p2: #ffff33;
            --sos-board: #333; --sos-cell: #444; --sos-p1: #ff3333; --sos-p2: #ffff33;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 5px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overscroll-behavior-y: contain; touch-action: manipulation;
        }

        /* --- START MENU --- */
        #start-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-btn {
            background: #333; border: 1px solid #555; color: white;
            padding: 15px 30px; margin: 10px; font-size: 1.1rem;
            border-radius: 8px; cursor: pointer; width: 250px;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .menu-btn:hover { background: #007bff; transform: scale(1.05); }

        /* --- UI ELEMENTS --- */
        h1 { margin: 5px 0; text-transform: uppercase; letter-spacing: 2px; font-size: 1.2rem; text-align: center; }

        #status-bar {
            background-color: #333; padding: 5px; border-radius: 8px;
            margin-bottom: 5px; text-align: center; width: 100%; max-width: 1000px;
            font-size: 1rem; font-weight: bold; transition: background-color 0.3s;
        }

        #control-bar { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; width: 100%; z-index: 100; flex-wrap: wrap; }
        .mini-btn {
            background-color: #444; color: #ccc; border: 1px solid #555;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; text-transform: uppercase; font-weight: bold;
        }
        .mini-btn:hover { background-color: #666; color: white; }
        .mini-btn.primary { background-color: #0055aa; border-color: #007bff; color: white; }
        
        #mute-btn { font-size: 1.2rem; padding: 2px 10px; min-width: 40px; }
        .muted-red { color: #ff5555 !important; border-color: #ff5555 !important; }

        #notify-row {
            display: flex; width: 100%; justify-content: space-between; align-items: center;
            min-height: 25px; margin-bottom: 2px; font-weight: bold; font-family: monospace;
            text-shadow: 0 0 5px rgba(0,0,0,0.8); pointer-events: none; padding: 0 10px; box-sizing: border-box;
        }
        .notify-box { flex: 1; opacity: 0; transition: opacity 0.5s; white-space: nowrap; overflow: visible; }
        #notify-left { text-align: left; color: #ff4444; }
        #notify-right { text-align: right; color: #00ff00; }
        
        .glow-red { opacity: 1 !important; animation: flashRed 1.5s infinite alternate; }
        .glow-green { opacity: 1 !important; animation: flashGreen 1.5s infinite alternate; }
        @keyframes flashRed { from { color: #ff9999; } to { color: #ff0000; } }
        @keyframes flashGreen { from { color: #ccffcc; } to { color: #00ff00; } }

        /* --- BATTLESHIP --- */
        #bs-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; }
        #bs-controls-container {
            display: flex; align-items: center; gap: 15px; margin-bottom: 5px;
            background: #333; padding: 5px 15px; border-radius: 8px;
        }
        #ship-preview-grid { display: grid; gap: 1px; width: 55px; height: 55px; align-content: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .preview-cell { width: 9px; height: 9px; background-color: var(--bs-ship); border: 1px solid #999; }

        #bs-game-area { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1000px; gap: 10px; }
        .board-container { display: flex; flex-direction: column; align-items: center; }
        .board-title { margin-bottom: 5px; font-size: 1rem; color: #aaa; }

        .bs-grid {
            display: grid; grid-template-columns: 30px repeat(10, 35px); grid-template-rows: 30px repeat(10, 35px);
            gap: 2px; background-color: #002244; padding: 5px; border-radius: 4px;
        }
        .bs-cell {
            background-color: var(--bs-water); width: 35px; height: 35px; font-size: 20px;
            display: flex; justify-content: center; align-items: center; user-select: none; position: relative;
        }
        .bs-header-cell { display: flex; justify-content: center; align-items: center; color: #88ccee; font-weight: bold; font-size: 0.8rem; }
        
        .bs-cell.ship { background-color: var(--bs-ship); border: 1px solid #555; }
        .bs-cell.hit { background-color: #441111; } 
        .bs-cell.hit::after { content: 'X'; color: var(--bs-hit); font-weight: bold; font-family: Arial, sans-serif; }
        .bs-cell.miss { background-color: #003366; } 
        .bs-cell.miss::after { content: ''; width: 30%; height: 30%; background-color: var(--bs-miss); border-radius: 50%; display: block; }
        #bs-cpu-grid .bs-cell.ship { background-color: var(--bs-water); border: none; }
        #bs-cpu-grid .bs-cell.ship.hit { background-color: #441111; border: 1px solid #555; }

        .bs-legend { margin-top: 5px; display: flex; gap: 20px; font-size: 0.9rem; color: #ccc; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .leg-icon { width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; }
        .leg-ship { background: var(--bs-ship); border: 1px solid #999; }
        .leg-hit { background: #441111; border: 1px solid #555; color: var(--bs-hit); font-weight: bold; }
        .leg-miss { background: #003366; border: 1px solid #555; }
        .leg-miss::after { content: ''; width: 8px; height: 8px; background: var(--bs-miss); border-radius: 50%; }

        /* --- GRAVITRIPS --- */
        #grav-wrapper { display: flex; flex-direction: column; align-items: center; }
        .grav-board-wrap { display: inline-block; background: var(--grav-board); padding: 10px; border-radius: 10px; margin-top: 0px; }
        .grav-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .grav-col-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 5px; }
        .grav-arrow { text-align: center; color: #88ccee; cursor: pointer; font-size: 1.5rem; user-select: none; }
        .grav-cell { width: 45px; height: 45px; background: #002244; border-radius: 50%; box-shadow: inset 0 0 8px rgba(0,0,0,0.8); }
        .grav-cell.p1 { background: var(--grav-p1); animation: drop 0.3s ease-out; }
        .grav-cell.p2 { background: var(--grav-p2); animation: drop 0.3s ease-out; }
        .grav-cell.winner { border: 3px solid white; animation: pulse 1s infinite; }
        @keyframes drop { from { transform: translateY(-300%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- SOS --- */
        #sos-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #sos-controls { display: flex; gap: 15px; margin-bottom: 5px; background: #333; padding: 5px 20px; border-radius: 8px; align-items: center; }
        #sos-scoreboard { display: flex; gap: 20px; margin-bottom: 5px; font-size: 1.2rem; font-weight: bold; background: #222; padding: 5px 15px; border-radius: 5px; border: 1px solid #444; }
        .sos-score { padding: 0 10px; }
        .sos-p1 { color: var(--sos-p1); }
        .sos-p2 { color: var(--sos-p2); }
        .sos-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; background: #333; padding: 5px; border-radius: 8px; }
        .sos-cell {
            width: 40px; height: 40px; background: var(--sos-cell);
            display: flex; justify-content: center; align-items: center;
            font-family: monospace; font-size: 1.5rem; font-weight: bold;
            color: #888; cursor: pointer; border-radius: 4px; transition: background 0.2s;
        }
        .sos-cell:hover { background: #555; }
        .sos-cell.s-p1, .sos-cell.o-p1 { color: var(--sos-p1); text-shadow: 0 0 5px rgba(255,50,50,0.5); }
        .sos-cell.s-p2, .sos-cell.o-p2 { color: var(--sos-p2); text-shadow: 0 0 5px rgba(255,255,50,0.5); }
        
        .letter-btn {
            width: 60px; height: 60px; 
            border: 2px solid #555; 
            background: #222; 
            color: #888; 
            font-size: 1.5rem; cursor: pointer; 
            font-weight: bold;
            transition: all 0.2s;
        }
        .letter-btn.active {
            border-color: #00ff00 !important;
            color: #00ff00 !important;
            background-color: #003300 !important;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* --- MODALS --- */
        .modal { position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; }
        
        .modal-content { 
            background: #2a2a2a; padding: 20px; border: 1px solid #555; 
            width: 95%; max-width: 450px; border-radius: 12px; text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }
        
        .close-btn { float: right; font-size: 24px; cursor: pointer; color: #aaa; margin-top: -10px; }
        .p2p-btn { background: var(--accent-p2p); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; margin-top: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        
        /* TABS for P2P */
        .tab-row { display: flex; border-bottom: 2px solid #444; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: none; border: none; color: #888; padding: 10px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: white; border-bottom: 2px solid var(--accent-p2p); margin-bottom: -2px; }
        
        /* CLOUD CONNECT STYLES */
        .code-display {
            background: #000; color: #00ff00; font-family: monospace; font-size: 2.5rem;
            padding: 15px; border-radius: 8px; border: 1px solid #444; margin: 15px 0; letter-spacing: 5px;
        }
        .code-input {
            background: #111; color: white; border: 1px solid #555; padding: 15px;
            font-size: 1.5rem; text-align: center; width: 200px; border-radius: 8px; letter-spacing: 2px;
            text-transform: uppercase;
        }
        .connect-status { color: #aaa; font-style: italic; margin-top: 10px; min-height: 20px; }

        /* MANUAL QR STYLES */
        #qrcode, #qrcode-answer { background: white; padding: 10px; width: 200px; height: 200px; margin: 10px auto; border-radius: 4px; }
        #qrcode img, #qrcode canvas { width: 100%; height: 100%; display: block; }
        .token-box { width: 100%; background: #111; border: 1px solid #444; color: #0f0; padding: 5px; margin: 10px 0; height: 40px; resize: none; font-family: monospace; font-size: 0.8rem; }
        #reader { width: 100%; background: black; min-height: 250px; border-radius: 5px; overflow: hidden; }

        .coffee-btn { display: inline-flex; align-items: center; justify-content: center; background: #FFDD00; color: #000; text-decoration: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; margin-top: 15px; font-size: 0.9rem; }
        .hidden { display: none !important; }

        /* --- RESPONSIVE --- */
        @media (orientation: landscape) {
            #notify-row { order: -1; width: 100%; margin-bottom: 2px; }
            #bs-game-area { justify-content: space-evenly; }
        }
        @media (orientation: portrait) {
            #bs-game-area { flex-direction: column; align-items: center; }
            #notify-row { order: 2; width: 100%; margin: 5px 0; }
            .board-container:first-child { order: 1; }
            .board-container:last-child { order: 3; }
        }
        @media (max-width: 450px) {
            .bs-grid { grid-template-columns: 20px repeat(10, 28px); grid-template-rows: 20px repeat(10, 28px); }
            .bs-cell { width: 28px; height: 28px; font-size: 16px; }
            .bs-header-cell { font-size: 0.6rem; }
            .sos-cell { width: 32px; height: 32px; font-size: 1.2rem; }
        }
        @media (orientation: landscape) and (max-height: 600px) {
            .bs-grid { grid-template-columns: 15px repeat(10, 22px); grid-template-rows: 15px repeat(10, 22px); gap: 1px; }
            .bs-cell { width: 22px; height: 22px; font-size: 12px; }
            .bs-header-cell { font-size: 0.5rem; }
        }
    </style>

    <style>
        /* HUD STRIP */
        #pk-hud {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #1e1e1e; border-bottom: 1px solid #444;
            z-index: 999999 !important;
            display: grid; 
            grid-template-columns: 1fr auto 1fr; /* Left, Center, Right */
            align-items: center;
            padding: 0 15px; box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* BUTTONS */
        #pk-hud button {
            background: #333; color: white; border: 1px solid #555;
            padding: 0 15px; cursor: pointer; font-weight: bold;
            border-radius: 4px; font-family: 'Segoe UI', sans-serif;
            transition: all 0.2s; white-space: nowrap;
            display: inline-flex; align-items: center; justify-content: center;
            height: 32px; margin: 0; font-size: 14px;
        }
        #pk-hud button:hover { background: #444; border-color: #777; }
        
        /* COFFEE BUTTON */
        #pk-hud .coffee-btn {
            background: #f1c40f !important; color: #2c3e50 !important;
            border: 1px solid #f39c12 !important;
        }
        #pk-hud .coffee-btn:hover { background: #f39c12 !important; }

        /* AUDIO BUTTON */
        #pk-hud .audio-btn {
            background: transparent !important; border: none !important;
            font-size: 20px !important; 
            padding: 0 10px !important;
            color: #ffffff !important; 
            min-width: 44px; /* Ensure click area is wide */
        }
        #pk-hud .audio-btn:hover { opacity: 0.8; }

        /* WRAPPERS */
        #parkour-wrapper {
            position: fixed !important; top: 50px !important; left: 0 !important;
            width: 100% !important; height: calc(100% - 50px) !important;
            z-index: 888888 !important; background: #000;
            display: none;
        }
        #pk-frame { width: 100%; height: 100%; border: none; display: block; }
        
        #stats-modal, .notify-box { z-index: 2147483647 !important; }
        body.pk-active #start-menu, body.pk-active .top-bar { display: none !important; }
    </style></head>
<body>

<div id="start-menu">
    <h1 style="color:white; letter-spacing:5px; margin-bottom:30px; text-transform:uppercase; font-size:2rem;">Game Center</h1>
    <button class="menu-btn" onclick="launch('battleship')">Battleship</button>
    <button class="menu-btn" onclick="launch('gravitrips')">Gravitrips</button>
    <button class="menu-btn" onclick="launch('sos')">S O S</button>
            <button class="menu-btn" onclick="launch('parkour')">Parkour</button>
    <div style="margin-top:50px; color:#555; font-family:monospace;">v8.4</div>
</div>

<div id="game-ui" class="hidden" style="width:100%; max-width:1000px; display:flex; flex-direction:column; align-items:center;">
<div id="parkour-wrapper"><iframe id="pk-frame"></iframe></div>
    <h1 id="game-title">GAME TITLE</h1>
    
    <div id="control-bar">
        <button id="multi-btn" class="mini-btn" onclick="openP2P()">Multiplayer</button>
        <button id="stats-btn" class="mini-btn" onclick="openStats()">Stats</button>
        <button id="mute-btn" class="mini-btn" onclick="toggleMute()">ðŸ”Š</button>
        <button id="exit-btn" class="mini-btn" onclick="attemptExit()">Exit</button>
        <button id="reset-game-btn" class="mini-btn primary hidden" onclick="resetCurrentGame()">Play Again</button>
    </div>

    <div id="status-bar">Initialize Systems...</div>

    <div id="bs-wrapper" class="hidden">
        <div id="bs-controls-container">
            <div id="ship-preview-container">
                <span style="font-size:0.9rem; color:#aaa;">Next:</span>
                <div id="ship-preview-grid"></div>
            </div>
            <button id="bs-rotate-btn" class="mini-btn primary" onclick="bs_rotate()">â†» Rotate</button>
            <button id="bs-reset-btn" class="mini-btn primary hidden" onclick="bs_init(gameMode)">Play Again</button>
        </div>
        <div id="bs-game-area">
            <div class="board-container">
                <div class="board-title" id="my-board-title">Friendly Waters</div>
                <div id="bs-player-grid" class="bs-grid"></div>
            </div>
            <div id="notify-row">
                <div id="notify-left" class="notify-box"></div> 
                <div id="notify-right" class="notify-box"></div> 
            </div>
            <div id="bs-cpu-board-container" class="board-container hidden">
                <div class="board-title" id="enemy-board-title">Enemy Waters</div>
                <div id="bs-cpu-grid" class="bs-grid"></div>
            </div>
        </div>
        <div class="bs-legend">
            <div class="legend-item"><div class="leg-icon leg-ship"></div> Ship</div>
            <div class="legend-item"><div class="leg-icon leg-hit">X</div> Hit</div>
            <div class="legend-item"><div class="leg-icon leg-miss"></div> Miss</div>
        </div>
    </div>

    <div id="grav-wrapper" class="hidden">
        <div class="grav-board-wrap">
            <div class="grav-col-header" id="grav-arrows"></div>
            <div id="grav-grid" class="grav-grid"></div>
        </div>
    </div>

    <div id="sos-wrapper" class="hidden">
        <div id="sos-scoreboard">
            <span class="sos-score sos-p1">You: <span id="sos-s1">0</span></span>
            <span class="sos-score sos-p2">Opp: <span id="sos-s2">0</span></span>
        </div>
        <div id="sos-controls">
            <span style="color:#aaa; margin-right:10px;">PLACE:</span>
            <button id="btn-s" class="letter-btn active" onclick="sos_setLetter('S')">S</button>
            <button id="btn-o" class="letter-btn" onclick="sos_setLetter('O')">O</button>
        </div>
        <div id="sos-grid" class="sos-grid"></div>
    </div>
</div>

<div id="stats-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModals()">&times;</span>
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:15px;">
            <h2 style="margin:0; color:#88ccee;">Statistics</h2>
            <span style="font-family:monospace; color:#666;">v8.4</span>
        </div>
        <div id="stats-content" style="background:#111; padding:15px; margin-bottom:15px; text-align:left; font-family:monospace; font-size:0.9rem; line-height:1.5;">
            </div>
        <a href="https://www.buymeacoffee.com/classmarks" target="_blank" class="coffee-btn">â˜• Buy me a coffee</a>
    </div>
</div>

<div id="p2p-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModals()">&times;</span>
        
        <h2 style="margin:0 0 20px 0; color:#88ccee; border-bottom:1px solid #555; padding-bottom:10px;">Multiplayer</h2>

        <div class="tab-row">
            <button class="tab-btn active" id="tab-cloud" onclick="switchTab('cloud')">Easy Connect</button>
            <button class="tab-btn" id="tab-manual" onclick="switchTab('manual')">Manual / QR</button>
        </div>

        <div id="content-cloud">
            <p style="color:#ccc; font-size:0.9rem;">Requires Internet.</p>
            
            <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h3 style="margin:0 0 10px 0; color:var(--accent-p2p);">HOST GAME</h3>
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <button id="cloud-host-btn" class="mini-btn primary" onclick="cloudHost()">Generate Code</button>
                    <div id="host-code-display" class="hidden">
                        <div class="code-display" id="my-room-code">----</div>
                        <div class="connect-status" id="host-status">Waiting for player...</div>
                    </div>
                </div>
            </div>

            <div style="background:#222; padding:15px; border-radius:8px;">
                <h3 style="margin:0 0 10px 0; color:#00ff00;">JOIN GAME</h3>
                <input type="text" id="join-code-input" class="code-input" placeholder="CODE" maxlength="4">
                <button class="p2p-btn" onclick="cloudJoin()" style="margin-top:10px;">Connect</button>
                <div class="connect-status" id="join-status"></div>
            </div>
        </div>

        <div id="content-manual" class="hidden">
            <h3 style="margin-top:0; color:#aaa;">Offline Mode (LAN/QR)</h3>
            <div id="manual-step-select">
                <button class="p2p-btn" onclick="manualHost()">I am Host (P1)</button>
                <button class="p2p-btn" onclick="manualJoin()">I am Joiner (P2)</button>
            </div>
            
            <div id="manual-host-view" class="hidden">
                <p>1. Show this to P2:</p>
                <div id="qrcode"></div>
                <textarea id="local-token" class="token-box" readonly onclick="this.select()"></textarea>
                <button class="p2p-btn" onclick="manualHostNext()">Next: Scan Answer</button>
            </div>

            <div id="manual-scan-view" class="hidden">
                <button class="mini-btn" onclick="toggleScan()">ðŸ“· Toggle Camera</button>
                <div id="reader" class="hidden"></div>
                <textarea id="remote-token" class="token-box" placeholder="Or paste code here..."></textarea>
                <button class="p2p-btn" onclick="manualProcess()">Process Code</button>
            </div>

            <div id="manual-p2-answer" class="hidden">
                <p>3. Show Answer to P1:</p>
                <div id="qrcode-answer"></div>
                <p class="connect-status">Waiting for P1 to confirm...</p>
            </div>
        </div>

    </div>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let activeGame = null, gameMode = 'cpu';
    let isP2P = false, isHost = true;
    let peer = null, conn = null; // PeerJS
    let manualPeer = null, manualChan = null; // Manual WebRTC
    let html5QrCode = null, isScanning = false;
    let gameInProgress = false;
    
    // SOUND
    let audioCtx = null;
    let isMuted = localStorage.getItem('gc_muted') === 'true';

    // TURN TRACKING
    let currentStarter = 1; 
    let nextStarter = 1; 

    // --- STATISTICS MANAGEMENT ---
    const defaultStats = { 
        cpu: { w: 0, d: 0, p: 0 }, 
        p2p: { w: 0, d: 0, l: 0 } 
    };
    
    let stats = JSON.parse(localStorage.getItem('gc_stats_v8')) || {
        battleship: JSON.parse(JSON.stringify(defaultStats)),
        gravitrips: JSON.parse(JSON.stringify(defaultStats)),
        sos: JSON.parse(JSON.stringify(defaultStats))
    };

    function saveStats() {
        localStorage.setItem('gc_stats_v8', JSON.stringify(stats));
    }

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(()=>{}); }
    
    // --- SOUND ENGINE ---
    function initAudio() {
        if (!window.AudioContext && !window.webkitAudioContext) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function toggleMute() {
        initAudio();
        isMuted = !isMuted;
        localStorage.setItem('gc_muted', isMuted);
        updateMuteBtn();
    }

    function updateMuteBtn() {
        const btn = document.getElementById('mute-btn');
        if(isMuted) {
            btn.innerHTML = 'ðŸ”‡';
            btn.classList.add('muted-red');
        } else {
            btn.innerHTML = 'ðŸ”Š';
            btn.classList.remove('muted-red');
        }
    }
    // Initialize btn on load
    updateMuteBtn();

    function playSound(type) {
        if(isMuted) return;
        initAudio(); // ensure context is active
        if(!audioCtx) return;

        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        // SINK (Explosion-ish)
        if(type === 'sink') {
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
            gain.gain.setValueAtTime(0.5, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(t + 0.5);
            return;
        }

        // GRAV CLICK (Plastic)
        if(type === 'grav-click') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(100, t + 0.05);
            gain.gain.setValueAtTime(0.5, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(t); osc.stop(t + 0.05);
            return;
        }

        // TADAH (Victory)
        if(type === 'tadah') { // Renamed from grav-win
            // Function to play one note
            const p = (freq, start, dur) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sawtooth'; o.frequency.setValueAtTime(freq, start);
                g.gain.setValueAtTime(0, start);
                g.gain.linearRampToValueAtTime(0.3, start + 0.05);
                g.gain.setValueAtTime(0.3, start + dur - 0.1);
                g.gain.linearRampToValueAtTime(0, start + dur);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(start); o.stop(start + dur);
            };
            p(523.25, t, 0.15); // C5
            p(698.46, t + 0.15, 0.4); // F5
            return;
        }

        // BS MISS (Splash)
        if(type === 'bs-miss') {
            const bufferSize = audioCtx.sampleRate * 0.5;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, t);
            filter.frequency.linearRampToValueAtTime(100, t + 0.3);
            gain.gain.setValueAtTime(0.5, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(t);
            return;
        }

        // SAD TROMBONE (Lose)
        if(type === 'sad-trombone') { // Renamed from bs-lose
            const pWah = (freq, start, dur, slide) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                const f = audioCtx.createBiquadFilter();
                o.type = 'sawtooth'; o.frequency.setValueAtTime(freq, start);
                if(slide) o.frequency.exponentialRampToValueAtTime(freq * 0.5, start + dur);
                f.type = 'lowpass'; f.Q.value = 4;
                f.frequency.setValueAtTime(200, start);
                f.frequency.linearRampToValueAtTime(800, start + (dur * 0.3));
                f.frequency.linearRampToValueAtTime(200, start + dur);
                g.gain.setValueAtTime(0, start);
                g.gain.linearRampToValueAtTime(0.4, start + 0.05);
                g.gain.linearRampToValueAtTime(0, start + dur);
                o.connect(f); f.connect(g); g.connect(audioCtx.destination);
                o.start(start); o.stop(start + dur);
            };
            let len = 0.35;
            pWah(392.00, t, len);
            pWah(369.99, t + len, len);
            pWah(349.23, t + (len*2), len);
            pWah(329.63, t + (len*3), 1.2, true);
            return;
        }
    }


    // --- MAIN LAUNCHER ---
    function launch(game) {
        initAudio(); // Trigger audio context unlock
        activeGame = game;
        document.getElementById('start-menu').style.display = 'none';
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('game-ui').style.display = 'flex';
        
        // Reset UI
        document.getElementById('notify-left').textContent = ""; document.getElementById('notify-left').className = "notify-box";
        document.getElementById('notify-right').textContent = ""; document.getElementById('notify-right').className = "notify-box";
        document.getElementById('bs-wrapper').classList.add('hidden');
        document.getElementById('grav-wrapper').classList.add('hidden');
        document.getElementById('sos-wrapper').classList.add('hidden');
        document.getElementById('reset-game-btn').classList.add('hidden'); 

        if (game === 'battleship') {
            document.getElementById('game-title').textContent = "BATTLESHIP";
            document.getElementById('bs-wrapper').classList.remove('hidden');
            bs_init('cpu');
        } else if (game === 'gravitrips') {
            document.getElementById('game-title').textContent = "GRAVITRIPS";
            document.getElementById('grav-wrapper').classList.remove('hidden');
            grav_init('cpu');
        } else if (game === 'sos') {
            document.getElementById('game-title').textContent = "SOS";
            document.getElementById('sos-wrapper').classList.remove('hidden');
            sos_init('cpu');
        }
    }

    function attemptExit() {
        if (gameInProgress && !confirm("Game in progress. Quit?")) return;
        location.reload();
    }

    function resetCurrentGame() {
        initAudio();
        if (activeGame === 'gravitrips') {
            if(isP2P) p2pSend({type:'RESET', nextTurn: nextStarter});
            grav_init(gameMode, nextStarter);
        }
        if (activeGame === 'sos') {
            if(isP2P) p2pSend({type:'RESET', nextTurn: nextStarter});
            sos_init(gameMode, nextStarter);
        }
        if (activeGame === 'battleship') {
            bs_init(gameMode);
        }
    }

    function openStats() {
        if (!activeGame || !stats[activeGame]) return;
        let s = stats[activeGame];
        
        // Calcs
        let cpu_l = s.cpu.p - s.cpu.w - s.cpu.d;
        let cpu_pct = s.cpu.p > 0 ? Math.round((s.cpu.w / s.cpu.p) * 100) + "%" : "--%";
        
        let p2p_total = s.p2p.w + s.p2p.d + s.p2p.l;
        let p2p_pct = p2p_total > 0 ? Math.round((s.p2p.w / p2p_total) * 100) + "%" : "--%";

        let html = `
            <strong>${activeGame.toUpperCase()}</strong><br><br>
            <u>VS CPU</u><br>
            Games won/drawn/lost: ${s.cpu.w} / ${s.cpu.d} / ${cpu_l}<br>
            Win percentage = ${cpu_pct}<br><br>
            <u>VS OPPONENT</u><br>
            Games won/drawn/lost: ${s.p2p.w} / ${s.p2p.d} / ${s.p2p.l}<br>
            Win percentage = ${p2p_pct}
        `;
        
        document.getElementById('stats-content').innerHTML = html;
        document.getElementById('stats-modal').style.display = 'flex';
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
        if(isScanning) toggleScan();
    }

    // --- BATTLESHIP LOGIC ---
    const BS_SIZE = 10;
    const BS_SHIPS_CFG = [{name:"Carrier",size:5}, {name:"Battleship",size:4}, {name:"Destroyer",size:3}, {name:"Submarine",size:3}, {name:"Patrol Boat",size:2}];
    let bs_pBoard=[], bs_cBoard=[], bs_pFleet=[], bs_cFleet=[], bs_pShips=[], bs_cShips=[];
    let bs_state='placement', bs_shipIdx=0, bs_isHoriz=true, bs_turn=true, bs_p2pReady=false;
    let bs_ai = { mode:'HUNT', targets:[], firstHit:null };

    function bs_init(mode) {
        gameMode = mode; gameInProgress = false;
        bs_pBoard = Array(BS_SIZE).fill(null).map(()=>Array(BS_SIZE).fill(0));
        bs_cBoard = Array(BS_SIZE).fill(null).map(()=>Array(BS_SIZE).fill(0));
        bs_pFleet = []; bs_cFleet = []; 
        bs_pShips = JSON.parse(JSON.stringify(BS_SHIPS_CFG)); 
        bs_cShips = JSON.parse(JSON.stringify(BS_SHIPS_CFG));
        bs_state = 'placement'; bs_shipIdx = 0; bs_turn = true; bs_isHoriz = true; bs_p2pReady = false;
        bs_ai = { mode:'HUNT', targets:[], firstHit:null };

        document.getElementById('notify-left').textContent = ""; document.getElementById('notify-left').className="notify-box";
        document.getElementById('notify-right').textContent = ""; document.getElementById('notify-right').className="notify-box";

        document.getElementById('bs-rotate-btn').classList.remove('hidden'); 
        document.getElementById('ship-preview-container').classList.remove('hidden');
        document.getElementById('bs-reset-btn').classList.add('hidden'); 
        document.getElementById('bs-controls-container').classList.remove('hidden');
        document.getElementById('bs-cpu-board-container').classList.add('hidden');
        
        document.getElementById('status-bar').style.background = "#333"; 
        document.getElementById('status-bar').textContent = "System Ready.";
        document.getElementById('enemy-board-title').textContent = mode==='cpu'?"Enemy Waters (CPU)":"Enemy Waters (P2P)";
        if(mode !== 'cpu') bs_turn = isHost;

        bs_updateStatus(); bs_updatePreview(); 
        document.getElementById('bs-rotate-btn').innerHTML = "â†» Rotate";
        bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true); 
        bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
    }

    function bs_rotate() { bs_isHoriz = !bs_isHoriz; bs_updatePreview(); }

    function bs_updateStatus() { 
        if(bs_state==='placement') document.getElementById('status-bar').textContent = `Deploying: ${bs_pShips[bs_shipIdx].name} (${bs_pShips[bs_shipIdx].size})`; 
    }
    
    function bs_updatePreview() {
        let el = document.getElementById('ship-preview-grid');
        el.innerHTML = '';
        if(bs_state!=='placement') { document.getElementById('ship-preview-container').classList.add('hidden'); return; }
        const s = bs_pShips[bs_shipIdx].size;
        el.style.gridTemplateColumns = bs_isHoriz ? `repeat(${s}, 9px)` : `9px`;
        el.style.gridTemplateRows = bs_isHoriz ? `9px` : `repeat(${s}, 9px)`;
        for(let i=0; i<s; i++) { let d = document.createElement('div'); d.className='preview-cell'; el.appendChild(d); }
    }

    function bs_render(el, data, isP) {
        el.innerHTML = ''; 
        el.className = `bs-grid ${isP&&bs_state==='placement'?'placement-mode':''} ${!isP&&bs_state==='combat'?'combat-mode':''}`;
        let h = document.createElement('div'); h.className='bs-header-cell'; el.appendChild(h);
        ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { let d = document.createElement('div'); d.className='bs-header-cell'; d.textContent=l; el.appendChild(d); });
        for(let r=0; r<BS_SIZE; r++) {
            let rowH = document.createElement('div'); rowH.className='bs-header-cell'; rowH.textContent=r+1; el.appendChild(rowH);
            for(let c=0; c<BS_SIZE; c++) {
                let cell = document.createElement('div'); cell.className = 'bs-cell'; let v = data[r][c];
                if(isP && v===1) cell.classList.add('ship'); if(v===2) cell.classList.add('miss'); if(v===3) cell.classList.add('ship','hit');
                if(isP && bs_state==='placement') cell.onclick = ()=>bs_place(r,c);
                else if(!isP && bs_state==='combat') cell.onclick = ()=>bs_attack(r,c);
                el.appendChild(cell);
            }
        }
    }

    function bs_place(r, c) {
        if(bs_state!=='placement') return;
        const s = bs_pShips[bs_shipIdx].size;
        if(bs_canPlace(bs_pBoard,r,c,s,bs_isHoriz)) {
            let newShip = { name: bs_pShips[bs_shipIdx].name, size: s, hits: 0, coords: [] };
            for(let i=0; i<s; i++) {
                let rp = bs_isHoriz ? r : r+i; let cp = bs_isHoriz ? c+i : c;
                bs_pBoard[rp][cp] = 1; newShip.coords.push({r:rp, c:cp});
            }
            bs_pFleet.push(newShip); bs_shipIdx++; 
            bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
            if(bs_shipIdx >= bs_pShips.length) {
                document.getElementById('bs-rotate-btn').classList.add('hidden'); 
                document.getElementById('ship-preview-container').classList.add('hidden'); 
                document.getElementById('bs-controls-container').classList.add('hidden');
                document.getElementById('bs-cpu-board-container').classList.remove('hidden');
                if(gameMode==='cpu') { 
                    bs_state='combat'; gameInProgress = true; 
                    bs_cpuDeploy(); 
                    bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false); 
                    document.getElementById('status-bar').textContent="Combat Active!"; 
                } else { 
                    document.getElementById('status-bar').textContent="Fleet Ready. Waiting for opponent..."; 
                    p2pSend({type:'READY'}); bs_checkP2P(); 
                }
            } else { bs_updateStatus(); bs_updatePreview(); }
        }
    }

    function bs_canPlace(b,r,c,s,h) {
        if(h) { if(c+s>10) return false; for(let i=0;i<s;i++) if(b[r][c+i]!==0) return false; } 
        else { if(r+s>10) return false; for(let i=0;i<s;i++) if(b[r+i][c]!==0) return false; }
        return true;
    }

    function bs_cpuDeploy() {
        bs_cShips.forEach(s => {
            let placed=false; 
            while(!placed) {
                let r=Math.floor(Math.random()*10); let c=Math.floor(Math.random()*10); let h=Math.random()>.5;
                if(bs_canPlace(bs_cBoard,r,c,s.size,h)) {
                    let ns = { name: s.name, size: s.size, hits: 0, coords: [] };
                    for(let i=0;i<s.size;i++) {
                        let rp = h ? r : r+i; let cp = h ? c+i : c;
                        bs_cBoard[rp][cp] = 1; ns.coords.push({r:rp, c:cp});
                    }
                    bs_cFleet.push(ns); placed=true;
                }
            }
        });
    }

    function bs_checkP2P() {
        if(bs_p2pReady && bs_state==='placement' && bs_shipIdx >= bs_pShips.length) {
            bs_state='combat'; gameInProgress=true;
            document.getElementById('status-bar').textContent = isHost ? "Your Turn" : "Enemy Turn";
            document.getElementById('enemy-board-title').textContent = "Enemy Waters (P2P)";
            bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
        }
    }

    function bs_notifyGood(msg) { let el=document.getElementById('notify-right'); el.textContent = msg; el.classList.add('glow-green'); }
    function bs_notifyBad(msg) { let el=document.getElementById('notify-left'); el.textContent = msg; el.classList.add('glow-red'); }

    function bs_attack(r, c) {
        if(bs_state!=='combat' || !bs_turn) return; if(bs_cBoard[r][c]>1) return;
        if(gameMode==='cpu') {
            let hit = bs_cBoard[r][c] === 1; let sunk = false; let sunkName = '';
            bs_cBoard[r][c] = hit ? 3 : 2;
            if(hit) {
                let t = bs_cFleet.find(s=>s.coords.some(k=>k.r===r && k.c===c));
                if(t) { t.hits++; if(t.hits>=t.size) { sunk=true; sunkName=t.name; playSound('sink'); } }
            } else {
                playSound('bs-miss'); // MISS SOUND
            }
            bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
            if(hit && bs_cFleet.every(s=>s.hits>=s.size)) { bs_end(true); } 
            else { 
                bs_turn=false; 
                if(sunk) bs_notifyGood(`ENEMY ${sunkName} SUNK!`);
                document.getElementById('status-bar').textContent = sunk ? `SUNK! ${sunkName}` : (hit?"HIT!":"Miss."); 
                setTimeout(bs_cpuTurn, 1000); 
            }
        } else {
            p2pSend({type:'ATTACK',r,c}); bs_turn=false; document.getElementById('status-bar').textContent="Firing...";
        }
    }

    function bs_cpuTurn() {
        let r, c, coords;
        if(bs_ai.mode === 'HUNT') coords = bs_randCoords();
        else if(bs_ai.mode === 'TARGET' || bs_ai.mode === 'KILL') {
            if(bs_ai.targets.length > 0) coords = bs_ai.targets.pop(); else { bs_ai.mode = 'HUNT'; coords = bs_randCoords(); }
        }
        if(bs_pBoard[coords.r][coords.c] > 1) { coords = bs_randCoords(); bs_ai.mode = 'HUNT'; }
        r=coords.r; c=coords.c;
        
        let hit = bs_pBoard[r][c] === 1; let sunk = false; let sunkName = ''; bs_pBoard[r][c] = hit ? 3 : 2;
        if(hit) {
            let t = bs_pFleet.find(s=>s.coords.some(k=>k.r===r && k.c===c));
            if(t) { t.hits++; if(t.hits>=t.size) { sunk=true; sunkName=t.name; playSound('sink'); } }
            if(sunk) { 
                bs_notifyBad(`LOST ${sunkName}!`); bs_ai.mode='HUNT'; bs_ai.targets=[]; bs_ai.firstHit=null; 
            } else {
                if(bs_ai.mode==='HUNT') { bs_ai.mode='TARGET'; bs_ai.firstHit={r,c}; bs_addTargs(r,c); }
                else if(bs_ai.mode==='TARGET') { bs_ai.mode='KILL'; bs_filterTargs(bs_ai.firstHit,{r,c}); bs_addNext(r,c,bs_ai.firstHit); }
                else if(bs_ai.mode==='KILL') { bs_addNext(r,c,bs_ai.firstHit); }
            }
        } else {
            playSound('bs-miss'); // CPU Miss
        }
        bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
        if(hit && bs_pFleet.every(s=>s.hits>=s.size)) { bs_end(false); } else { bs_turn=true; document.getElementById('status-bar').textContent = "Your Turn"; }
    }
    
    function bs_randCoords() { let r,c,t=0; do{r=Math.floor(Math.random()*10);c=Math.floor(Math.random()*10);t++}while(bs_pBoard[r][c]>1&&t<200); return {r,c}; }
    function bs_addTargs(r,c) { [{r:-1,c:0},{r:1,c:0},{r:0,c:-1},{r:0,c:1}].sort(()=>Math.random()-.5).forEach(d=>{ let nr=r+d.r, nc=c+d.c; if(nr>=0&&nr<10&&nc>=0&&nc<10&&bs_pBoard[nr][nc]<2) bs_ai.targets.push({r:nr,c:nc}); }); }
    function bs_filterTargs(h1, h2) { let horiz = h1.r === h2.r; bs_ai.targets = bs_ai.targets.filter(t => horiz ? t.r===h1.r : t.c===h1.c); }
    function bs_addNext(cr, cc, orig) { let dr=0, dc=0; if(cr>orig.r)dr=1; else if(cr<orig.r)dr=-1; if(cc>orig.c)dc=1; else if(cc<orig.c)dc=-1; let nr=cr+dr, nc=cc+dc; if(nr>=0&&nr<10&&nc>=0&&nc<10&&bs_pBoard[nr][nc]<2) bs_ai.targets.push({r:nr,c:nc}); }

    function bs_end(won) {
        bs_state='gameover'; gameInProgress = false;
        document.getElementById('status-bar').textContent = won ? "VICTORY!" : "DEFEAT!";
        document.getElementById('status-bar').style.background = won ? "green" : "#b30000";
        document.getElementById('bs-reset-btn').classList.remove('hidden'); 
        document.getElementById('bs-controls-container').classList.remove('hidden');
        
        if(won) playSound('tadah'); // VICTORY FANFARE
        else playSound('sad-trombone'); // DEFEAT SOUND

        // STATS UPDATE
        if(gameMode === 'cpu') {
            stats.battleship.cpu.p++;
            if(won) stats.battleship.cpu.w++;
        } else {
            if(won) stats.battleship.p2p.w++; else stats.battleship.p2p.l++;
        }
        saveStats();
    }

    // --- GRAVITRIPS ---
    const G_ROWS = 6, G_COLS = 7;
    let grav_board=[], grav_turn=1, grav_myId=1, grav_locked=false;
    
    function grav_init(mode, startPlayer = 1) {
        gameMode = mode; 
        grav_board = Array(G_ROWS).fill(null).map(()=>Array(G_COLS).fill(0));
        grav_locked = false; grav_myId = (mode==='p2p'&&!isHost) ? 2 : 1; 
        grav_turn = startPlayer; 
        currentStarter = startPlayer; // Track for tie logic
        gameInProgress = false;
        
        // HIDE PLAY AGAIN BUTTON
        document.getElementById('reset-game-btn').classList.add('hidden');

        let grid = document.getElementById('grav-grid'); grid.innerHTML='';
        for(let r=0;r<G_ROWS;r++) for(let c=0;c<G_COLS;c++) { let d=document.createElement('div'); d.className='grav-cell'; d.dataset.r=r; d.dataset.c=c; d.onclick=()=>grav_drop(c); grid.appendChild(d); }
        let arrows = document.getElementById('grav-arrows'); arrows.innerHTML='';
        for(let c=0;c<G_COLS;c++) { let a=document.createElement('div'); a.className='grav-arrow'; a.textContent='â–¼'; a.onclick=()=>grav_drop(c); arrows.appendChild(a); }
        grav_updStat();

        // FIX: Trigger CPU if it goes first
        if(mode === 'cpu' && startPlayer === 2) {
            grav_locked = true;
            setTimeout(grav_cpu, 1000); // 1s delay for visual readiness
        }
    }

    function grav_drop(col) {
        if(grav_locked || grav_turn!==grav_myId) return;
        for(let r=G_ROWS-1;r>=0;r--) { if(grav_board[r][col]===0) { gameInProgress = true; grav_anim(r,col,grav_myId); if(gameMode==='p2p') p2pSend({type:'MOVE',col,p:grav_myId}); return; }}
    }

    function grav_anim(r,c,p) {
        playSound('grav-click'); // PLASTIC SOUND TRIGGER
        grav_locked = true; grav_board[r][c] = p;
        let cell = document.querySelector(`.grav-cell[data-r="${r}"][data-c="${c}"]`);
        cell.classList.add(p===1?'p1':'p2');
        setTimeout(()=>{ 
            if(grav_checkWin(p)) grav_end(p===grav_myId); 
            else if(grav_board.every(row=>row.every(k=>k!==0))) { grav_end(false, true); } // Draw
            else { grav_turn = p===1?2:1; grav_locked=false; grav_updStat(); if(gameMode==='cpu' && grav_turn===2) { grav_locked=true; setTimeout(grav_cpu, 500); }}
        },400);
    }

    function grav_cpu() { 
        let col = -1; 
        for(let c=0; c<G_COLS; c++) if(grav_sim(c,2)) { col=c; break; } 
        if(col<0) for(let c=0; c<G_COLS; c++) if(grav_sim(c,1)) { col=c; break; } 
        if(col<0) { let a=[]; for(let c=0;c<G_COLS;c++) if(grav_board[0][c]===0) a.push(c); col=a[Math.floor(Math.random()*a.length)]; } 
        for(let r=G_ROWS-1;r>=0;r--) if(grav_board[r][col]===0) { grav_anim(r,col,2); break; } 
    }

    function grav_sim(c,p) { 
        if(grav_board[0][c]!==0) return false; let r; for(r=G_ROWS-1;r>=0;r--) if(grav_board[r][c]===0) break; 
        grav_board[r][c]=p; let w=grav_checkWin(p); grav_board[r][c]=0; return w; 
    }

    function grav_checkWin(p) { 
        for(let r=0;r<G_ROWS;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r][c+1]==p&&grav_board[r][c+2]==p&&grav_board[r][c+3]==p) return true; 
        for(let r=0;r<G_ROWS-3;r++) for(let c=0;c<G_COLS;c++) if(grav_board[r][c]==p&&grav_board[r+1][c]==p&&grav_board[r+2][c]==p&&grav_board[r+3][c]==p) return true; 
        for(let r=3;r<G_ROWS;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r-1][c+1]==p&&grav_board[r-2][c+2]==p&&grav_board[r-3][c+3]==p) return true; 
        for(let r=0;r<G_ROWS-3;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r+1][c+1]==p&&grav_board[r+2][c+2]==p&&grav_board[r+3][c+3]==p) return true; 
        return false; 
    }

    function grav_end(won, isDraw=false) { 
        grav_locked=true; gameInProgress = false; 
        document.getElementById('reset-game-btn').classList.remove('hidden');
        
        if(won) playSound('tadah'); // TA-DAH
        else if(!isDraw) playSound('sad-trombone'); // DEFEAT SOUND

        let opponentId = grav_myId === 1 ? 2 : 1;

        if (isDraw) {
            document.getElementById('status-bar').textContent = "DRAW GAME!"; 
            document.getElementById('status-bar').style.background = "#555";
            nextStarter = currentStarter; // Tie = starter goes again
            
            // Stats
            if(gameMode === 'cpu') stats.gravitrips.cpu.d++;
            else stats.gravitrips.p2p.d++;
        } else {
            document.getElementById('status-bar').textContent = won?"VICTORY!":"DEFEAT!"; 
            document.getElementById('status-bar').style.background = won?"green":"#b30000"; 
            
            // Winner starts next
            nextStarter = won ? grav_myId : opponentId;

            // Stats
            if(gameMode === 'cpu') {
                stats.gravitrips.cpu.p++;
                if(won) stats.gravitrips.cpu.w++;
            } else {
                if(won) stats.gravitrips.p2p.w++; else stats.gravitrips.p2p.l++;
            }
        }
        
        if(gameMode === 'cpu' && isDraw) stats.gravitrips.cpu.p++;

        saveStats();
    }

    function grav_updStat() { 
        // Initial Banner Logic for new games
        if(!gameInProgress && gameMode === 'p2p') {
            if(grav_turn === grav_myId) {
                document.getElementById('status-bar').textContent="New Game Started: YOUR TURN"; 
                document.getElementById('status-bar').style.background="#005500"; 
            } else {
                document.getElementById('status-bar').textContent="New Game Started: OPPONENT TURN"; 
                document.getElementById('status-bar').style.background="#550000"; 
            }
            return;
        }

        if(grav_turn===grav_myId) { 
            document.getElementById('status-bar').textContent="YOUR TURN"; 
            document.getElementById('status-bar').style.background="#333"; 
        } 
        else { 
            document.getElementById('status-bar').textContent = gameMode==='cpu' ? "CPU TURN" : "OPPONENT TURN"; 
        } 
    }

    // --- SOS ---
    const S_ROWS = 7, S_COLS = 8;
    let sos_board=[], sos_turn=1, sos_myId=1, sos_scores={1:0, 2:0}, sos_sel='S', sos_locked=false;
    
    function sos_init(mode, startPlayer = 1) {
        gameMode = mode; 
        sos_board = Array(S_ROWS).fill(null).map(()=>Array(S_COLS).fill(null));
        sos_locked = false; sos_myId = (mode==='p2p'&&!isHost) ? 2 : 1; 
        sos_turn = startPlayer; 
        currentStarter = startPlayer; // Track for ties
        sos_scores={1:0, 2:0}; sos_sel='S'; gameInProgress = false;
        
        document.getElementById('reset-game-btn').classList.add('hidden');

        document.getElementById('sos-s1').textContent = "0"; 
        document.getElementById('sos-s2').textContent = "0"; 
        sos_setLetter('S'); sos_updStat();
        
        const grid = document.getElementById('sos-grid'); grid.innerHTML = '';
        for(let r=0;r<S_ROWS;r++) for(let c=0;c<S_COLS;c++) {
            let d = document.createElement('div'); d.className='sos-cell'; d.dataset.r=r; d.dataset.c=c;
            d.onclick=()=>sos_move(r,c); grid.appendChild(d);
        }

        // FIX: Trigger CPU if it goes first
        if(mode === 'cpu' && startPlayer === 2) {
            sos_locked = true;
            setTimeout(sos_cpu, 1000);
        }
    }
    
    function sos_setLetter(l) { 
        sos_sel = l; 
        document.getElementById('btn-s').classList.remove('active');
        document.getElementById('btn-o').classList.remove('active');
        if(l==='S') document.getElementById('btn-s').classList.add('active');
        else document.getElementById('btn-o').classList.add('active');
    }

    function sos_move(r, c) {
        if(sos_locked || sos_board[r][c]!==null || sos_turn!==sos_myId) return;
        gameInProgress = true;
        sos_apply(r, c, sos_sel, sos_myId);
        if(gameMode === 'p2p') p2pSend({type:'SOS_MOVE', r, c, l:sos_sel, p:sos_myId});
    }

    function sos_apply(r, c, l, p) {
        sos_locked = true; sos_board[r][c] = l;
        let cell = document.querySelector(`.sos-cell[data-r="${r}"][data-c="${c}"]`);
        cell.textContent = l; cell.classList.add(`${l.toLowerCase()}-p${p}`);
        let pts = sos_checkPoints(r, c, l);
        sos_scores[p] += pts;
        document.getElementById(`sos-s${p}`).textContent = sos_scores[p];
        if(sos_board.every(row => row.every(cell => cell !== null))) { sos_end(); } 
        else { 
            if(pts === 0) sos_turn = (sos_turn===1)?2:1; 
            sos_updStat(); sos_locked = false; 
            if(gameMode === 'cpu' && sos_turn === 2) { sos_locked = true; setTimeout(sos_cpu, 500); }
        }
    }

    function sos_checkPoints(r, c, l) {
        let pts = 0;
        const g = (rr, cc) => (rr>=0 && rr<S_ROWS && cc>=0 && cc<S_COLS) ? sos_board[rr][cc] : '';
        if(l === 'S') {
            const dirs = [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
            dirs.forEach(([dr, dc]) => { if(g(r+dr, c+dc) === 'O' && g(r+dr*2, c+dc*2) === 'S') pts++; });
        } else { 
            if(g(r, c-1)==='S' && g(r, c+1)==='S') pts++;
            if(g(r-1, c)==='S' && g(r+1, c)==='S') pts++;
            if(g(r-1, c-1)==='S' && g(r+1, c+1)==='S') pts++;
            if(g(r-1, c+1)==='S' && g(r+1, c-1)==='S') pts++;
        }
        return pts;
    }

    function sos_cpu() {
        let best = null;
        for(let r=0; r<S_ROWS; r++) { for(let c=0; c<S_COLS; c++) { if(sos_board[r][c] === null) {
            sos_board[r][c] = 'S'; if(sos_checkPoints(r,c,'S') > 0) best = {r,c,l:'S'}; sos_board[r][c] = null; if(best) break;
            sos_board[r][c] = 'O'; if(sos_checkPoints(r,c,'O') > 0) best = {r,c,l:'O'}; sos_board[r][c] = null; if(best) break;
        }} if(best) break; }

        if(!best) {
            let empty = []; for(let r=0; r<S_ROWS; r++) for(let c=0; c<S_COLS; c++) if(sos_board[r][c]===null) empty.push({r,c});
            let pick = empty[Math.floor(Math.random()*empty.length)];
            best = {r:pick.r, c:pick.c, l: (Math.random()>.5?'S':'O')};
        }
        sos_apply(best.r, best.c, best.l, 2);
    }

    function sos_updStat() {
        if(!gameInProgress && gameMode === 'p2p') {
            if(sos_turn === sos_myId) {
                document.getElementById('status-bar').textContent="New Game Started: YOUR TURN"; 
                document.getElementById('status-bar').style.background="#005500"; 
            } else {
                document.getElementById('status-bar').textContent="New Game Started: OPPONENT TURN"; 
                document.getElementById('status-bar').style.background="#550000"; 
            }
            return;
        }

        if(sos_turn === sos_myId) { document.getElementById('status-bar').textContent = "YOUR TURN"; document.getElementById('status-bar').style.background = "#333"; }
        else { document.getElementById('status-bar').textContent = gameMode==='cpu' ? "CPU TURN" : "OPPONENT TURN"; }
    }

    function sos_end() {
        gameInProgress = false;
        document.getElementById('reset-game-btn').classList.remove('hidden');

        let myScore = sos_scores[sos_myId];
        let oppScore = sos_scores[sos_myId === 1 ? 2 : 1];
        let opponentId = sos_myId === 1 ? 2 : 1;
        
        let won = myScore > oppScore;
        let draw = myScore === oppScore;

        if(draw) { 
            document.getElementById('status-bar').textContent = "DRAW GAME!"; 
            document.getElementById('status-bar').style.background = "#555";
            nextStarter = currentStarter; 
            
            if(gameMode === 'cpu') stats.sos.cpu.d++;
            else stats.sos.p2p.d++;
        }
        else {
            document.getElementById('status-bar').textContent = won ? "VICTORY!" : "DEFEAT!"; 
            document.getElementById('status-bar').style.background = won ? "green" : "#b30000";
            nextStarter = won ? sos_myId : opponentId;

            if(won) playSound('tadah');
            else playSound('sad-trombone');

            if(gameMode === 'cpu') {
                stats.sos.cpu.p++;
                if(won) stats.sos.cpu.w++;
            } else {
                if(won) stats.sos.p2p.w++; else stats.sos.p2p.l++;
            }
        }
        if(gameMode === 'cpu' && draw) stats.sos.cpu.p++;
        saveStats();
    }

    // --- NETWORKING (DUAL MODE: PEERJS + MANUAL) ---
    
    function openP2P() {
        closeModals();
        document.getElementById('p2p-modal').style.display='flex';
        switchTab('cloud');
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('content-cloud').classList.add('hidden');
        document.getElementById('content-manual').classList.add('hidden');
        document.getElementById('content-'+t).classList.remove('hidden');
    }

    // --- CLOUD MODE (FIXED FOR RACE CONDITIONS) ---
    function cloudHost() {
        const code = Math.floor(1000 + Math.random() * 9000);
        const fullId = 'gc7-' + code;
        
        document.getElementById('cloud-host-btn').classList.add('hidden');
        document.getElementById('host-code-display').classList.remove('hidden');
        document.getElementById('my-room-code').textContent = code;
        isHost = true;
        
        peer = new Peer(fullId, {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        });
        
        peer.on('open', (id) => { console.log("Hosted: " + id); });
        
        peer.on('connection', (c) => {
            conn = c;
            document.getElementById('host-status').textContent = "Player found! Opening channel...";
            if(conn.open) { finalSetup(); } 
            else { conn.on('open', finalSetup); }
        });
        
        peer.on('error', (err) => {
            console.error(err);
            if(err.type === 'unavailable-id') cloudHost();
            else document.getElementById('host-status').textContent = "Error: " + err.type;
        });
    }

    function cloudJoin() {
        const code = document.getElementById('join-code-input').value;
        if(code.length !== 4) return alert("Enter 4 digit code");
        
        isHost = false;
        document.getElementById('join-status').textContent = "Dialing host...";
        
        peer = new Peer(null, {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        });

        peer.on('open', () => {
            document.getElementById('join-status').textContent = "Handshaking...";
            conn = peer.connect('gc7-' + code, { reliable: true, serialization: 'json' });
            if(conn.open) { finalSetup(); } 
            else { conn.on('open', finalSetup); }
            
            setTimeout(() => {
                if(!isP2P) document.getElementById('join-status').textContent = "Stuck? Try Manual/QR mode.";
            }, 8000);
        });
        
        peer.on('error', (err) => { document.getElementById('join-status').textContent = "Connection Failed. Try again."; });
    }

    function finalSetup() {
        closeModals();
        isP2P = true;
        
        conn.on('data', (data) => handleData(data));
        conn.on('close', () => alert("Opponent disconnected"));

        if(activeGame==='battleship') bs_init('p2p');
        else if(activeGame==='gravitrips') grav_init('p2p');
        else sos_init('p2p');
    }
    
    function p2pSend(data) {
        if(conn && conn.open) conn.send(data);
        else if(manualChan && manualChan.readyState==='open') manualChan.send(JSON.stringify(data));
    }

    function handleData(data) {
        let msg = (typeof data === 'string') ? JSON.parse(data) : data;

        if (msg.type === 'RESET') {
            if (activeGame === 'gravitrips') {
                grav_init('p2p', msg.nextTurn);
            }
            if (activeGame === 'sos') {
                sos_init('p2p', msg.nextTurn);
            }
            return;
        }

        if(activeGame==='battleship') {
            if(msg.type==='READY') { bs_p2pReady=true; bs_checkP2P(); }
            else if(msg.type==='ATTACK') {
                let hit=false, sunk=false; let t=bs_pFleet.find(s=>s.coords.some(k=>k.r===msg.r && k.c===msg.c));
                if(t && bs_pBoard[msg.r][msg.c]!==3) { 
                    bs_pBoard[msg.r][msg.c]=3; hit=true; t.hits++; 
                    if(t.hits>=t.size) { sunk=true; playSound('sink'); }
                } else if(!t) { 
                    bs_pBoard[msg.r][msg.c]=2;
                    playSound('bs-miss'); 
                }
                bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
                p2pSend({type:'RESULT',r:msg.r,c:msg.c,hit,sunk,sunkName:t?t.name:''});
                if(sunk) bs_notifyBad(`LOST ${t.name}!`);
                if(bs_pFleet.every(s=>s.hits>=s.size)) { p2pSend({type:'GAMEOVER'}); bs_end(false); } else { bs_turn=true; document.getElementById('status-bar').textContent="YOUR TURN"; }
            }
            else if(msg.type==='RESULT') {
                bs_cBoard[msg.r][msg.c] = msg.hit?3:2; bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
                if(msg.sunk) { bs_notifyGood(`ENEMY ${msg.sunkName} SUNK!`); playSound('sink'); }
                else if(msg.hit) document.getElementById('status-bar').textContent="HIT!"; 
                else { document.getElementById('status-bar').textContent="Miss."; playSound('bs-miss'); }
            }
            else if(msg.type==='GAMEOVER') bs_end(true);
        }
        else if(msg.type==='MOVE') { 
            gameInProgress = true; 
            for(let r=G_ROWS-1;r>=0;r--) if(grav_board[r][msg.col]===0) { grav_anim(r,msg.col,msg.p); break; } 
        }
        else if(msg.type==='SOS_MOVE') { 
            gameInProgress = true; 
            sos_apply(msg.r, msg.c, msg.l, msg.p); 
        }
    }

    // --- MANUAL / QR MODE (BACKUP) ---
    function manualHost() {
        isHost = true;
        document.getElementById('manual-step-select').classList.add('hidden');
        document.getElementById('manual-host-view').classList.remove('hidden');
        setupManualWebRTC();
    }
    
    function manualJoin() {
        isHost = false;
        document.getElementById('manual-step-select').classList.add('hidden');
        document.getElementById('manual-scan-view').classList.remove('hidden');
    }

    function manualHostNext() {
        document.getElementById('manual-host-view').classList.add('hidden');
        document.getElementById('manual-scan-view').classList.remove('hidden');
    }

    function setupManualWebRTC() {
        manualPeer = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        manualPeer.onicecandidate = e => {
            if(!e.candidate) {
                let sdp = JSON.stringify(manualPeer.localDescription);
                let compressed = LZString.compressToEncodedURIComponent(sdp);
                
                let target = isHost ? 'qrcode' : 'qrcode-answer';
                let txtTarget = isHost ? 'local-token' : null;
                
                document.getElementById(target).innerHTML = '';
                new QRCode(document.getElementById(target), { text: compressed, width: 180, height: 180 });
                if(txtTarget) document.getElementById(txtTarget).value = compressed;
                
                if(!isHost) {
                     document.getElementById('manual-scan-view').classList.add('hidden');
                     document.getElementById('manual-p2-answer').classList.remove('hidden');
                }
            }
        };

        if(isHost) {
            manualChan = manualPeer.createDataChannel("game");
            manualChan.onopen = () => { closeModals(); isP2P=true; if(activeGame==='battleship') bs_init('p2p'); else if(activeGame==='gravitrips') grav_init('p2p'); else sos_init('p2p'); };
            manualChan.onmessage = e => handleData(e.data);
            manualPeer.createOffer().then(d => manualPeer.setLocalDescription(d));
        } else {
            manualPeer.ondatachannel = e => {
                manualChan = e.channel;
                manualChan.onopen = () => { closeModals(); isP2P=true; if(activeGame==='battleship') bs_init('p2p'); else if(activeGame==='gravitrips') grav_init('p2p'); else sos_init('p2p'); };
                manualChan.onmessage = e => handleData(e.data);
            }
        }
    }

    function manualProcess() {
        let txt = document.getElementById('remote-token').value;
        try {
            let decomp = LZString.decompressFromEncodedURIComponent(txt);
            let desc = JSON.parse(decomp);
            
            if(isHost) {
                manualPeer.setRemoteDescription(desc);
            } else {
                setupManualWebRTC(); // Init peer
                manualPeer.setRemoteDescription(desc);
                manualPeer.createAnswer().then(d => manualPeer.setLocalDescription(d));
            }
        } catch(e) { alert("Invalid Code"); }
    }

    function toggleScan() {
        let btn = document.querySelector('#manual-scan-view .mini-btn');
        if(isScanning) { 
            html5QrCode.stop().then(() => {
                isScanning = false; document.getElementById('reader').classList.add('hidden'); btn.textContent="ðŸ“· Toggle Camera";
            });
        } else {
            document.getElementById('reader').classList.remove('hidden'); 
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { 
                document.getElementById('remote-token').value = txt; manualProcess();
            });
            isScanning = true; btn.textContent="â¹ Stop Camera";
        }
    }


// === PARKOUR V34 LOGIC ===
const PK_CODE = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Impossible Parkour - Lower Stickman</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #dcdcdc;
            overflow: hidden; 
            touch-action: none; 
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
        }

        #score {
            font-size: 2rem;
            font-weight: bold;
            color: #111;
            margin: 20px;
            text-shadow: 2px 2px 0px #fff;
            opacity: 0; 
            transition: opacity 0.3s;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.0); 
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            padding-top: 2vh; 
            align-items: center;
            pointer-events: auto;
            z-index: 10;
            transition: opacity 0.3s;
        }

        .title-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 50px; 
            border-radius: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; 
        }

        h1 { 
            margin: 0; 
            font-size: 3rem; 
            text-transform: uppercase; 
            letter-spacing: -3px; 
            font-weight: 900;
            line-height: 1; 
            color: #111;
        }

        .crashed-text {
            color: #c0392b; 
        }

        .stats-container {
            margin: 5px 0 20px 0;
        }

        #current-score-display {
            font-size: 1.6rem; 
            font-weight: bold;
            color: #111;
            margin: 0;
            display: none; 
        }

        #high-score-display {
            color: #666; 
            font-size: 1.1rem; 
            margin: 2px 0 0 0;
        }

        .small-best {
            font-size: 0.9rem !important;
            opacity: 0.8;
        }
        
        .btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 15px 50px; 
            font-size: 1.5rem;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 5px 0 #444;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #444;
        }

        .tap-hint {
            position: absolute;
            bottom: 30px; 
            width: 100%;
            text-align: center;
            color: #555; 
            font-size: 0.85rem;
            animation: pulse 2s infinite;
            white-space: nowrap;
        }

        @keyframes pulse { 
            0% { opacity: 0.5; } 
            50% { opacity: 1.0; } 
            100% { opacity: 0.5; } 
        }
    </style>
<style>html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;}</style></head>
<body>

    <div id="ui-layer">
        <div id="score">0m</div>
        <div class="tap-hint">Tap to Jump â€¢ Double Tap to Somersault</div>
    </div>

    <div id="start-screen">
        <div class="title-container">
            <h1 id="main-title">Parkour Run</h1>
            
            <div class="stats-container">
                <p id="current-score-display">Current Run: 0m</p>
                <p id="high-score-display">Best Run: 0m</p>
            </div>

            <button class="btn" id="start-btn">RUN</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const scoreEl = document.getElementById('score');
        const mainTitle = document.getElementById('main-title');
        const currentScoreEl = document.getElementById('current-score-display');
        const highScoreEl = document.getElementById('high-score-display');

        let width, height;
        let startFloorY; 

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            
            // CHANGE: Lowered floor to 85% to be closer to instructions
            startFloorY = height * 0.85;

            if (!gameActive) {
                player.y = startFloorY - 60; 
                player.x = width / 2;
            }
        }
        window.addEventListener('resize', resize);
        
        // Game State
        let gameActive = false;
        let score = 0;
        let highScore = localStorage.getItem('parkourHighScore') || 0;
        
        highScoreEl.innerText = \`Best Run: \${highScore}m\`;
        
        let speed = 7;
        let gravity = 0.6;
        let lastTime = 0;

        const player = {
            x: 0, 
            y: 0,
            vy: 0, 
            width: 20,
            height: 60,
            grounded: false,
            jumpCount: 0,
            color: '#111',
            runFrame: 0
        };

        let platforms = [];

        // --- INIT ---
        resize(); 
        player.x = width / 2;
        player.y = startFloorY - 60;
        
        lastTime = performance.now();
        requestAnimationFrame(loop);

        function drawSegment(x, y, angle, length) {
            const endX = x + Math.sin(angle) * length;
            const endY = y + Math.cos(angle) * length;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(endX, endY);
            ctx.stroke();
            return { x: endX, y: endY };
        }

        function jump() {
            if (player.grounded) {
                player.vy = -13; 
                player.grounded = false;
                player.jumpCount = 1;
            } 
            else if (player.jumpCount < 2) {
                player.vy = -11;
                player.jumpCount = 2;
                player.runFrame = 0; 
            }
        }

        window.addEventListener('touchstart', (e) => {
            if (e.target !== startBtn) { 
                e.preventDefault(); 
                jump();
            }
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (e.target !== startBtn) jump();
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') jump();
        });

        startBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            startGame();
        });
        startBtn.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            startGame();
        });

        function startGame() {
            gameActive = true;
            
            startScreen.style.opacity = '0';
            setTimeout(() => { startScreen.style.display = 'none'; }, 300);
            scoreEl.style.opacity = '1';

            score = 0;
            speed = 7;
            player.x = 100; 
            player.y = height / 2;
            player.vy = 0;
            player.jumpCount = 0;
            
            platforms = [];
            platforms.push({ x: 0, y: height - 100, w: width * 3, h: 100 });
        }

        function gameOver() {
            gameActive = false;
            
            let finalScore = Math.floor(score);
            if (finalScore > highScore) {
                highScore = finalScore;
                localStorage.setItem('parkourHighScore', highScore);
            }

            mainTitle.innerText = "CRASHED!";
            mainTitle.classList.add('crashed-text');
            
            currentScoreEl.style.display = "block";
            currentScoreEl.innerText = \`Current Run: \${finalScore}m\`;
            
            highScoreEl.innerText = \`Best Run: \${highScore}m\`;
            highScoreEl.classList.add('small-best');

            startBtn.innerText = "PLAY AGAIN";
            
            startScreen.style.display = 'flex';
            requestAnimationFrame(() => { startScreen.style.opacity = '1'; });
            scoreEl.style.opacity = '0';

            player.x = width / 2;
            player.y = startFloorY - 60;
            player.vy = 0;
        }

        function generatePlatform() {
            const lastPlat = platforms[platforms.length - 1];
            const minGap = 120;
            const maxGap = 280 + (speed * 4); 
            const gap = Math.floor(Math.random() * (maxGap - minGap + 1) + minGap);
            let newY = lastPlat.y + (Math.random() * 120 - 60);
            if (newY > height - 60) newY = height - 60;
            if (newY < height / 2.5) newY = height / 2.5;
            const w = Math.floor(Math.random() * 400 + 150);
            platforms.push({ x: lastPlat.x + lastPlat.w + gap, y: newY, w: w, h: 100 });
        }

        function drawStickman(x, y, dt) {
            ctx.strokeStyle = player.color;
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            let animRate = (12 + (speed * 0.5)); 
            
            if (player.grounded) {
                player.runFrame += animRate * dt;
            } else {
                if (player.jumpCount === 2) {
                    player.runFrame += 20 * dt; 
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(player.runFrame);
                    ctx.translate(-x, -y);
                } else {
                    player.runFrame = 0.8; 
                }
            }

            // Torso 
            let torsoAngle = 0.3;
            const headX = x + Math.sin(torsoAngle) * 25;
            const headY = y - Math.cos(torsoAngle) * 25;

            ctx.beginPath();
            ctx.moveTo(x, y); ctx.lineTo(headX, headY); ctx.stroke();
            ctx.beginPath(); ctx.arc(headX + 2, headY - 8, 7, 0, Math.PI * 2); ctx.fill(); 

            // --- LEGS ---
            const thighLen = 18;
            const shinLen = 20;
            let rCycle = player.runFrame;
            let lCycle = player.runFrame + Math.PI; 

            let rThighAngle = Math.sin(rCycle) * 1.1 + 0.1; 
            let lThighAngle = Math.sin(lCycle) * 1.1 + 0.1;
            let rBend = Math.max(0, Math.cos(rCycle) * 2.0) + 0.2;
            let lBend = Math.max(0, Math.cos(lCycle) * 2.0) + 0.2;
            let rShinAngle = rThighAngle - rBend;
            let lShinAngle = lThighAngle - lBend;

            // --- ARMS BASE ---
            const armLen = 15;
            const foreArmLen = 15;
            let rArmBase = Math.sin(lCycle); 
            let lArmBase = Math.sin(rCycle);
            let rArmAngle = rArmBase * 0.9 - 0.3; 
            let lArmAngle = lArmBase * 0.9 - 0.3;
            let rElbowBend = 1.3 + (rArmBase * 0.6);
            let lElbowBend = 1.3 + (lArmBase * 0.6);

            // --- JUMP OVERRIDES ---
            if(!player.grounded && player.jumpCount !== 2) {
                // Right Leg (Front)
                rThighAngle = 1.2; 
                rShinAngle = 0.5; 
                
                // Left Leg (Rear)
                lThighAngle = -0.5; 
                lShinAngle = lThighAngle - 0.16; 

                // --- ARMS FIXED POSE ---
                // Right Arm (Front)
                rArmAngle = 1.83; 
                rElbowBend = 0.52; 

                // Left Arm (Rear)
                lArmAngle = -2.32; 
                lElbowBend = 0.5;
            }

            let rKnee = drawSegment(x, y, rThighAngle, thighLen);
            drawSegment(rKnee.x, rKnee.y, rShinAngle, shinLen);
            let lKnee = drawSegment(x, y, lThighAngle, thighLen);
            drawSegment(lKnee.x, lKnee.y, lShinAngle, shinLen);

            let rElbow = drawSegment(headX, headY, rArmAngle, armLen);
            drawSegment(rElbow.x, rElbow.y, rArmAngle + rElbowBend, foreArmLen); 
            let lElbow = drawSegment(headX, headY, lArmAngle, armLen);
            drawSegment(lElbow.x, lElbow.y, lArmAngle + lElbowBend, foreArmLen);

            if (!player.grounded && player.jumpCount === 2) ctx.restore();
        }

        function loop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            if (dt > 0.1) { requestAnimationFrame(loop); return; }

            ctx.clearRect(0, 0, width, height); 

            const timeScale = dt / (1/60); 

            player.vy += gravity * timeScale;
            player.y += player.vy * timeScale;
            player.grounded = false;

            // --- GAME MODE ---
            if (gameActive) {
                score += speed * dt * 3; 
                scoreEl.innerText = Math.floor(score) + "m";
                if (speed < 16) speed += 0.1 * dt;

                if (platforms.length < 5) generatePlatform();
                if (platforms[0].x + platforms[0].w < 0) platforms.shift();

                ctx.fillStyle = "#222";
                platforms.forEach(p => {
                    p.x -= speed * timeScale;
                    ctx.fillRect(p.x, p.y, p.w, p.h);
                    
                    if (player.vy >= 0 && player.y + 60 > p.y && player.y - 20 < p.y + p.h && player.x + 10 > p.x && player.x - 10 < p.x + p.w) {
                        if (player.y + 60 < p.y + 40) { 
                            player.y = p.y - 60; player.vy = 0; player.grounded = true; player.jumpCount = 0;
                            if(player.jumpCount === 2) player.runFrame = 0;
                        }
                    }
                });

                if (player.y > height) gameOver();
            } 
            
            // --- TITLE / CRASHED MODE ---
            else {
                const floorY = startFloorY;
                
                ctx.beginPath();
                ctx.moveTo(width/2 - 50, floorY);
                ctx.lineTo(width/2 + 50, floorY);
                ctx.strokeStyle = "#bbb";
                ctx.lineWidth = 2;
                ctx.stroke();

                if (player.y + 60 > floorY) {
                    player.y = floorY - 60;
                    player.vy = 0;
                    player.grounded = true;
                    player.jumpCount = 0;
                }
            }

            drawStickman(player.x, player.y + 30, dt); 
            requestAnimationFrame(loop);
        }
    <\/script>
</body>
</html>`;
const COFFEE_URL = "https://buymeacoffee.com/classmarks";

function pk_initHud() {
    if(document.getElementById('pk-hud')) return;
    
    // Determine Initial Icon using Unicode
    var icon = "\uD83D\uDD0A";
    if(typeof isMuted !== 'undefined' && isMuted) icon = "\uD83D\uDD07";
    
    let d = document.createElement('div');
    d.id = 'pk-hud';
    d.style.display = 'none';
    
    // v23 Grid Layout with Unicode Icons
    d.innerHTML = `
        <div style="text-align:left;">
            <button onclick="attemptExit()">Exit</button>
        </div>
        <div style="text-align:center;">
            <button class="coffee-btn" onclick="window.open(COFFEE_URL, '_blank')">\u2615 Buy Me A Coffee</button>
        </div>
        <div style="text-align:right;">
            <button id="pk-audio-btn" class="audio-btn" onclick="pk_toggleAudio()">${icon}</button>
        </div>
    `;
    document.body.appendChild(d);
}

function pk_toggleAudio() {
    // 1. Flip the Global Variable
    if(typeof isMuted !== 'undefined') {
        isMuted = !isMuted;
    } else {
        window.isMuted = true;
    }

    // 2. FORCE SAVE to LocalStorage (This creates the persistence)
    localStorage.setItem('gc_muted', isMuted); 

    // 3. Update the Parkour HUD Button Icon
    let btn = document.getElementById('pk-audio-btn');
    if(btn) {
        // Use the Unicode icons directly to avoid syntax errors
        btn.innerText = isMuted ? "\uD83D\uDD07" : "\uD83D\uDD0A"; 
    }

    // 4. Update the running Game (Live Sync)
    let frame = document.getElementById('pk-frame');
    if(frame && frame.contentWindow) {
        frame.contentWindow.isMuted = isMuted;
    }
    
    // 5. Sync Main Menu Button (So it matches when you exit)
    let mainBtn = document.getElementById('mute-btn'); 
    if(mainBtn) {
        mainBtn.innerHTML = isMuted ? "" : ""; 
        if(isMuted) mainBtn.classList.add('muted-red');
        else mainBtn.classList.remove('muted-red');
    }
}

window.launch = function(game) {
    if(typeof initAudio === 'function') initAudio(); 
    activeGame = game;
    
    // Reset State
    document.body.classList.remove('pk-active');
    if(document.getElementById('pk-hud')) document.getElementById('pk-hud').style.display='none';
    if(document.getElementById('parkour-wrapper')) document.getElementById('parkour-wrapper').style.display='none';
    
    ['bs-wrapper','grav-wrapper','sos-wrapper'].forEach(id=>{
        let el=document.getElementById(id); if(el) el.classList.add('hidden');
    });

    let nl=document.getElementById('notify-left'); if(nl) nl.innerText="";
    let nr=document.getElementById('notify-right'); if(nr) nr.innerText="";
    
    document.getElementById('start-menu').style.display='none';
    document.getElementById('game-ui').classList.remove('hidden');
    document.getElementById('game-ui').style.display='flex';

    if(game === 'battleship') {
        document.getElementById('bs-wrapper').classList.remove('hidden');
        if(typeof bs_init==='function') bs_init('cpu');
    }
    else if(game === 'gravitrips') {
        document.getElementById('grav-wrapper').classList.remove('hidden');
        if(typeof grav_init==='function') grav_init('cpu');
    }
    else if(game === 'sos') {
        document.getElementById('sos-wrapper').classList.remove('hidden');
        if(typeof sos_init==='function') sos_init('cpu');
    }
    else if(game === 'parkour') {
        document.body.classList.add('pk-active');
        pk_initHud();
        document.getElementById('pk-hud').style.display='grid';
        
        // Sync Icon on Launch
        let btn = document.getElementById('pk-audio-btn');
        if(btn && typeof isMuted !== 'undefined') {
             btn.innerText = isMuted ? "\uD83D\uDD07" : "\uD83D\uDD0A";
        }

        let wrap = document.getElementById('parkour-wrapper');
        wrap.style.display = 'block'; 
        
        let mb = document.getElementById('multi-btn'); if(mb) mb.classList.add('hidden');
        
        let frame = document.getElementById('pk-frame');
        // MANUAL FIX: Force the game to use our global mute setting
        let globalMute = (typeof isMuted !== 'undefined') ? isMuted : false;
        frame.srcdoc = PK_CODE.replace(/isMuted\s*=\s*false/, "isMuted = " + globalMute);
        setTimeout(()=>frame.contentWindow.focus(), 200);
    }
};

window.attemptExit = function() {
    if(activeGame === 'parkour') {
        document.getElementById('pk-frame').srcdoc = "";
        document.body.classList.remove('pk-active');
        document.getElementById('pk-hud').style.display='none';
        document.getElementById('parkour-wrapper').style.display='none';
    }
    if (typeof gameInProgress !== 'undefined' && gameInProgress && !confirm("Quit?")) return;
    location.reload();
};
            
</script>
</body>
</html>
