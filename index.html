<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Center v6.2</title>
    <meta name="theme-color" content="#222">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-color: #222; --text-color: white; --accent-p2p: #8a2be2;
            --bs-water: #004488; --bs-ship: #777777; --bs-hit: #cc3300; --bs-miss: #ffffff;
            --grav-board: #004488; --grav-p1: #ff3333; --grav-p2: #ffff33;
            --sos-board: #333; --sos-cell: #444; --sos-p1: #ff3333; --sos-p2: #ffff33;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 5px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overscroll-behavior-y: contain; touch-action: manipulation;
        }

        /* --- START MENU --- */
        #start-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-btn {
            background: #333; border: 1px solid #555; color: white;
            padding: 15px 30px; margin: 10px; font-size: 1.1rem;
            border-radius: 8px; cursor: pointer; width: 250px;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .menu-btn:hover { background: #007bff; transform: scale(1.05); }

        h1 { margin: 5px 0; text-transform: uppercase; letter-spacing: 2px; font-size: 1.2rem; text-align: center; }

        /* --- SHARED UI --- */
        #status-bar {
            background-color: #333; padding: 5px; border-radius: 8px;
            margin-bottom: 5px; text-align: center; width: 100%; max-width: 1000px;
            font-size: 1rem; font-weight: bold; transition: background-color 0.3s;
        }

        #control-bar { display: flex; gap: 10px; margin-bottom: 5px; justify-content: center; width: 100%; z-index: 100; }
        .mini-btn {
            background-color: #444; color: #ccc; border: 1px solid #555;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; text-transform: uppercase; font-weight: bold;
        }
        .mini-btn:hover { background-color: #666; color: white; }
        .mini-btn.primary { background-color: #0055aa; border-color: #007bff; color: white; }
        .mini-btn.active { background-color: #007bff; color: white; border-color: white; }

        #notify-row {
            display: flex; width: 100%; justify-content: space-between; align-items: center;
            min-height: 25px; margin-bottom: 2px; font-weight: bold; font-family: monospace;
            text-shadow: 0 0 5px rgba(0,0,0,0.8); pointer-events: none; padding: 0 10px; box-sizing: border-box;
        }
        .notify-box { flex: 1; opacity: 0; transition: opacity 0.5s; white-space: nowrap; overflow: visible; }
        #notify-left { text-align: left; color: #ff4444; }
        #notify-right { text-align: right; color: #00ff00; }
        
        .glow-red { opacity: 1 !important; animation: flashRed 1.5s infinite alternate; text-shadow: 0 0 10px #ff0000; }
        .glow-green { opacity: 1 !important; animation: flashGreen 1.5s infinite alternate; text-shadow: 0 0 10px #00ff00; }
        @keyframes flashRed { from { color: #ff9999; } to { color: #ff0000; } }
        @keyframes flashGreen { from { color: #ccffcc; } to { color: #00ff00; } }

        /* --- BATTLESHIP --- */
        #bs-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; }
        #bs-controls-container {
            display: flex; align-items: center; gap: 15px; margin-bottom: 5px;
            background: #333; padding: 5px 15px; border-radius: 8px;
        }
        #ship-preview-grid { display: grid; gap: 1px; width: 55px; height: 55px; align-content: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .preview-cell { width: 9px; height: 9px; background-color: var(--bs-ship); border: 1px solid #999; }

        #bs-game-area { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1000px; gap: 10px; }
        .board-container { display: flex; flex-direction: column; align-items: center; }
        .board-title { margin-bottom: 5px; font-size: 1rem; color: #aaa; }

        .bs-grid {
            display: grid; grid-template-columns: 30px repeat(10, 35px); grid-template-rows: 30px repeat(10, 35px);
            gap: 2px; background-color: #002244; padding: 5px; border-radius: 4px;
        }
        .bs-cell {
            background-color: var(--bs-water); width: 35px; height: 35px; font-size: 20px;
            display: flex; justify-content: center; align-items: center; user-select: none; position: relative;
        }
        .bs-header-cell { display: flex; justify-content: center; align-items: center; color: #88ccee; font-weight: bold; font-size: 0.8rem; }
        
        .bs-cell.ship { background-color: var(--bs-ship); border: 1px solid #555; }
        .bs-cell.hit { background-color: #441111; } 
        .bs-cell.hit::after { content: 'X'; color: var(--bs-hit); font-weight: bold; font-family: Arial, sans-serif; }
        .bs-cell.miss { background-color: #003366; } 
        .bs-cell.miss::after { content: ''; width: 30%; height: 30%; background-color: var(--bs-miss); border-radius: 50%; display: block; }
        #bs-cpu-grid .bs-cell.ship { background-color: var(--bs-water); border: none; }
        #bs-cpu-grid .bs-cell.ship.hit { background-color: #441111; border: 1px solid #555; }

        .bs-legend { margin-top: 5px; display: flex; gap: 20px; font-size: 0.9rem; color: #ccc; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .leg-icon { width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        .leg-ship { background: var(--bs-ship); border: 1px solid #999; }
        .leg-hit { background: #441111; border: 1px solid #555; color: var(--bs-hit); font-weight: bold; font-family: Arial, sans-serif; }
        .leg-miss { background: #003366; border: 1px solid #555; }
        .leg-miss::after { content: ''; width: 8px; height: 8px; background: var(--bs-miss); border-radius: 50%; }

        /* --- GRAVITRIPS --- */
        #grav-wrapper { display: flex; flex-direction: column; align-items: center; }
        .grav-board-wrap { display: inline-block; background: var(--grav-board); padding: 10px; border-radius: 10px; margin-top: 0px; }
        .grav-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .grav-col-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 5px; }
        .grav-arrow { text-align: center; color: #88ccee; cursor: pointer; font-size: 1.5rem; user-select: none; }
        .grav-cell { width: 45px; height: 45px; background: #002244; border-radius: 50%; box-shadow: inset 0 0 8px rgba(0,0,0,0.8); }
        .grav-cell.p1 { background: var(--grav-p1); animation: drop 0.3s ease-out; }
        .grav-cell.p2 { background: var(--grav-p2); animation: drop 0.3s ease-out; }
        .grav-cell.winner { border: 3px solid white; animation: pulse 1s infinite; }
        @keyframes drop { from { transform: translateY(-300%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- SOS --- */
        #sos-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #sos-controls { display: flex; gap: 15px; margin-bottom: 5px; background: #333; padding: 5px 20px; border-radius: 8px; align-items: center; }
        #sos-scoreboard { display: flex; gap: 20px; margin-bottom: 5px; font-size: 1.2rem; font-weight: bold; background: #222; padding: 5px 15px; border-radius: 5px; border: 1px solid #444; }
        .sos-score { padding: 0 10px; }
        .sos-p1 { color: var(--sos-p1); }
        .sos-p2 { color: var(--sos-p2); }
        .sos-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; background: #333; padding: 5px; border-radius: 8px; }
        .sos-cell {
            width: 40px; height: 40px; background: var(--sos-cell);
            display: flex; justify-content: center; align-items: center;
            font-family: monospace; font-size: 1.5rem; font-weight: bold;
            color: #888; cursor: pointer; border-radius: 4px; transition: background 0.2s;
        }
        .sos-cell:hover { background: #555; }
        .sos-cell.s-p1, .sos-cell.o-p1 { color: var(--sos-p1); text-shadow: 0 0 5px rgba(255,50,50,0.5); }
        .sos-cell.s-p2, .sos-cell.o-p2 { color: var(--sos-p2); text-shadow: 0 0 5px rgba(255,255,50,0.5); }
        @media (max-width: 400px) { .sos-cell { width: 32px; height: 32px; font-size: 1.2rem; } }

        /* --- MODALS --- */
        .modal { position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; }
        
        .modal-content { 
            background: #333; padding: 25px; border: 1px solid #555; 
            width: 90%; max-width: 450px; border-radius: 10px; text-align: center;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        
        .close-btn { position: sticky; top: 0; right: 0; float: right; font-size: 24px; cursor: pointer; color: #888; z-index: 1000; background: #333; padding-left: 10px; }
        .p2p-btn { background: var(--accent-p2p); color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .token-box { width: 100%; background: #111; border: 1px solid #444; color: #0f0; padding: 5px; margin: 10px 0; height: 60px; resize: none; font-family: monospace; }
        
        /* --- QR CODE & READER --- */
        #qrcode { 
            background: white; padding: 10px; width: 220px; height: 220px; margin: 0 auto; 
            cursor: zoom-in; transition: transform 0.2s; 
            display: flex; justify-content: center; align-items: center;
            color: black; font-weight: bold; position: relative;
        }
        
        #qrcode img, #qrcode canvas { display: block; max-width: 100%; height: auto; }

        /* QR FULLSCREEN FIX */
        #qrcode.qr-fullscreen {
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh;
            max-width: none; max-height: none; 
            transform: none; 
            z-index: 5000;
            background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border: none; box-shadow: none;
            cursor: zoom-out;
        }
        
        #qrcode.qr-fullscreen img, #qrcode.qr-fullscreen canvas {
            background: white; padding: 15px; border-radius: 5px;
            max-width: 90vmin; max-height: 80vmin;
            width: auto; height: auto;
            border: 5px solid white;
        }

        #qr-hint { display: none; color: white; margin-top: 20px; font-size: 1.2rem; animation: pulse 1.5s infinite; }
        #qrcode.qr-fullscreen #qr-hint { display: block; }
        @keyframes pulse { 0% { opacity:0.6; } 50% { opacity:1; } 100% { opacity:0.6; } }

        .gen-anim { animation: pulseText 1.5s infinite; font-size: 1.1rem; color: #555; }
        @keyframes pulseText { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* CAMERA CONTAINER */
        #reader { 
            width: 100%; background: black; margin-bottom: 10px;
            position: relative; overflow: hidden; border-radius: 5px;
            min-height: 250px; 
        }
        #reader video { object-fit: cover; width: 100% !important; height: auto !important; }

        .coffee-btn { display: inline-flex; align-items: center; justify-content: center; background: #FFDD00; color: #000; text-decoration: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; margin-top: 15px; font-size: 0.9rem; }
        .hidden { display: none !important; }

        /* --- RESPONSIVE --- */
        @media (orientation: landscape) {
            #notify-row { order: -1; width: 100%; margin-bottom: 2px; }
            #bs-game-area { justify-content: space-evenly; }
        }
        @media (orientation: portrait) {
            #bs-game-area { flex-direction: column; align-items: center; }
            #notify-row { order: 2; width: 100%; margin: 5px 0; }
            .board-container:first-child { order: 1; }
            .board-container:last-child { order: 3; }
        }
        @media (max-width: 450px) {
            .bs-grid { grid-template-columns: 20px repeat(10, 28px); grid-template-rows: 20px repeat(10, 28px); }
            .bs-cell { width: 28px; height: 28px; font-size: 16px; }
            .bs-header-cell { font-size: 0.6rem; }
            .sos-cell { width: 32px; height: 32px; font-size: 1.2rem; }
        }
        @media (orientation: landscape) and (max-height: 600px) {
            .bs-grid { grid-template-columns: 15px repeat(10, 22px); grid-template-rows: 15px repeat(10, 22px); gap: 1px; }
            .bs-cell { width: 22px; height: 22px; font-size: 12px; }
            .bs-header-cell { font-size: 0.5rem; }
        }
    </style>
</head>
<body>

<div id="start-menu">
    <h1 style="color:white; letter-spacing:5px; margin-bottom:30px; text-transform:uppercase; font-size:2rem;">Game Center</h1>
    <button class="menu-btn" onclick="launch('battleship')">Battleship</button>
    <button class="menu-btn" onclick="launch('gravitrips')">Gravitrips</button>
    <button class="menu-btn" onclick="launch('sos')">S O S</button>
    <div style="margin-top:50px; color:#555; font-family:monospace;">v6.2</div>
</div>

<div id="game-ui" class="hidden" style="width:100%; max-width:1000px; display:flex; flex-direction:column; align-items:center;">
    <h1 id="game-title">GAME TITLE</h1>
    <div id="status-bar">Initialize Systems...</div>

    <div id="control-bar">
        <button id="opt-btn" class="mini-btn" onclick="openOptions()">OPTIONS</button>
        <button id="exit-btn" class="mini-btn" onclick="attemptExit()">EXIT</button>
        <button id="reset-game-btn" class="mini-btn primary hidden" onclick="resetCurrentGame()">NEW GAME</button>
    </div>

    <div id="bs-wrapper" class="hidden">
        <div id="bs-controls-container">
            <div id="ship-preview-container">
                <span style="font-size:0.9rem; color:#aaa;">Next:</span>
                <div id="ship-preview-grid"></div>
            </div>
            <button id="bs-rotate-btn" class="mini-btn primary" onclick="bs_rotate()">â†» Rotate</button>
            <button id="bs-reset-btn" class="mini-btn primary hidden" onclick="bs_init(gameMode)">Play Again</button>
        </div>
        <div id="bs-game-area">
            <div class="board-container">
                <div class="board-title" id="my-board-title">Friendly Waters</div>
                <div id="bs-player-grid" class="bs-grid"></div>
            </div>
            <div id="notify-row">
                <div id="notify-left" class="notify-box"></div> 
                <div id="notify-right" class="notify-box"></div> 
            </div>
            <div id="bs-cpu-board-container" class="board-container hidden">
                <div class="board-title" id="enemy-board-title">Enemy Waters</div>
                <div id="bs-cpu-grid" class="bs-grid"></div>
            </div>
        </div>
        <div class="bs-legend">
            <div class="legend-item"><div class="leg-icon leg-ship"></div> Ship</div>
            <div class="legend-item"><div class="leg-icon leg-hit">X</div> Hit</div>
            <div class="legend-item"><div class="leg-icon leg-miss"></div> Miss</div>
        </div>
    </div>

    <div id="grav-wrapper" class="hidden">
        <div class="grav-board-wrap">
            <div class="grav-col-header" id="grav-arrows"></div>
            <div id="grav-grid" class="grav-grid"></div>
        </div>
    </div>

    <div id="sos-wrapper" class="hidden">
        <div id="sos-scoreboard">
            <span class="sos-score sos-p1">You: <span id="sos-s1">0</span></span>
            <span class="sos-score sos-p2">Opp: <span id="sos-s2">0</span></span>
        </div>
        <div id="sos-controls">
            <span style="color:#aaa; margin-right:10px;">PLACE:</span>
            <button id="btn-s" class="mini-btn active" onclick="sos_setLetter('S')">S</button>
            <button id="btn-o" class="mini-btn" onclick="sos_setLetter('O')">O</button>
        </div>
        <div id="sos-grid" class="sos-grid"></div>
    </div>
</div>

<div id="secret-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModals()">&times;</span>
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:15px;">
            <h2 style="margin:0; color:#88ccee;">P2P and Stats</h2>
            <span style="font-family:monospace; color:#666;">v6.2</span>
        </div>
        <div id="stats-area" style="background:#111; padding:10px; margin-bottom:15px;">Stats: 0/0</div>
        <button class="p2p-btn" onclick="openP2P()">Start P2P Game Link</button>
        <a href="https://www.buymeacoffee.com/classmarks" target="_blank" class="coffee-btn">â˜• Buy me a coffee</a>
    </div>
</div>

<div id="p2p-modal" class="modal">
    <div class="modal-content" style="max-width:450px;">
        <span class="close-btn" onclick="closeModals()">&times;</span>
        <h2 style="margin-bottom:15px; color:var(--accent-p2p);">P2P Game Link</h2>
        <div style="text-align:left; margin-bottom:20px;">
            <span style="color:#88ccee; font-weight:bold;">1. YOUR CODE (Tap to Zoom)</span>
            <div id="qrcode" onclick="toggleQRZoom()">
                <span class="gen-anim">Generating...</span>
                <div id="qr-hint">Tap anywhere to minimize</div>
            </div>
            <textarea id="local-token" class="token-box" readonly onclick="this.select()"></textarea>
        </div>
        <div style="text-align:left; border-top:1px solid #444; padding-top:15px;">
            <span style="color:#88ccee; font-weight:bold;">2. TARGET CODE</span>
            <button id="cam-toggle-btn" class="mini-btn" onclick="toggleScan()" style="width:100%; margin-bottom:10px; background:#444; font-size:1rem;">ðŸ“· Toggle Camera</button>
            <div id="reader" class="hidden"></div>
            <textarea id="remote-token" class="token-box" placeholder="Paste friend's code..."></textarea>
            <button class="p2p-btn" onclick="processRemote()">Connect</button>
        </div>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES ---
    let activeGame = null;
    let gameMode = 'cpu';
    let isP2P = false, isHost = true;
    let peerConn = null, dataChan = null, html5QrCode = null, isScanning = false;
    let audioCtx = null;
    let gameInProgress = false;

    // View References & Stats
    const stats = {
        battleship: { p: parseInt(localStorage.getItem('bs_played')||0), w: parseInt(localStorage.getItem('bs_won')||0) },
        gravitrips: { p: parseInt(localStorage.getItem('grav_played')||0), w: parseInt(localStorage.getItem('grav_won')||0) },
        sos: { p: parseInt(localStorage.getItem('sos_played')||0), w: parseInt(localStorage.getItem('sos_won')||0) }
    };

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
    }

    // --- MAIN LAUNCHER ---
    function launch(game) {
        activeGame = game;
        document.getElementById('start-menu').style.display = 'none';
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('game-ui').style.display = 'flex';
        
        document.getElementById('notify-left').textContent = ""; document.getElementById('notify-left').className = "notify-box";
        document.getElementById('notify-right').textContent = ""; document.getElementById('notify-right').className = "notify-box";
        document.getElementById('bs-wrapper').classList.add('hidden');
        document.getElementById('grav-wrapper').classList.add('hidden');
        document.getElementById('sos-wrapper').classList.add('hidden');
        document.getElementById('reset-game-btn').classList.add('hidden');

        if (game === 'battleship') {
            document.getElementById('game-title').textContent = "BATTLESHIP";
            document.getElementById('bs-wrapper').classList.remove('hidden');
            bs_init('cpu');
        } else if (game === 'gravitrips') {
            document.getElementById('game-title').textContent = "GRAVITRIPS";
            document.getElementById('grav-wrapper').classList.remove('hidden');
            document.getElementById('reset-game-btn').classList.remove('hidden');
            grav_init('cpu');
        } else if (game === 'sos') {
            document.getElementById('game-title').textContent = "SOS COMMAND";
            document.getElementById('sos-wrapper').classList.remove('hidden');
            document.getElementById('reset-game-btn').classList.remove('hidden');
            sos_init('cpu');
        }
    }

    function attemptExit() {
        if (gameInProgress && !confirm("Game in progress. Quit?")) return;
        location.reload();
    }

    function resetCurrentGame() {
        if (activeGame === 'gravitrips') grav_init(gameMode);
        if (activeGame === 'sos') sos_init(gameMode);
    }

    function openOptions() {
        if (!activeGame || !stats[activeGame]) return;
        let s = stats[activeGame];
        document.getElementById('stats-area').textContent = `${activeGame.toUpperCase()} vs CPU: Won ${s.w} / ${s.p}`;
        document.getElementById('secret-modal').style.display = 'flex';
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
        if(isScanning) toggleScan();
        document.getElementById('qrcode').classList.remove('qr-fullscreen');
    }

    function playSinkSound() {
        try {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        } catch (e) {}
    }

    // --- BATTLESHIP LOGIC ---
    const BS_SIZE = 10;
    const BS_SHIPS_CFG = [{name:"Carrier",size:5}, {name:"Battleship",size:4}, {name:"Destroyer",size:3}, {name:"Submarine",size:3}, {name:"Patrol Boat",size:2}];
    let bs_pBoard=[], bs_cBoard=[], bs_pFleet=[], bs_cFleet=[], bs_pShips=[], bs_cShips=[];
    let bs_state='placement', bs_shipIdx=0, bs_isHoriz=true, bs_turn=true, bs_p2pReady=false;
    let bs_ai = { mode:'HUNT', targets:[], firstHit:null };

    function bs_init(mode) {
        gameMode = mode; gameInProgress = false;
        bs_pBoard = Array(BS_SIZE).fill(null).map(()=>Array(BS_SIZE).fill(0));
        bs_cBoard = Array(BS_SIZE).fill(null).map(()=>Array(BS_SIZE).fill(0));
        bs_pFleet = []; bs_cFleet = []; 
        bs_pShips = JSON.parse(JSON.stringify(BS_SHIPS_CFG)); 
        bs_cShips = JSON.parse(JSON.stringify(BS_SHIPS_CFG));
        bs_state = 'placement'; bs_shipIdx = 0; bs_turn = true; bs_isHoriz = true; bs_p2pReady = false;
        bs_ai = { mode:'HUNT', targets:[], firstHit:null };

        document.getElementById('notify-left').textContent = ""; document.getElementById('notify-left').className="notify-box";
        document.getElementById('notify-right').textContent = ""; document.getElementById('notify-right').className="notify-box";

        document.getElementById('bs-rotate-btn').classList.remove('hidden'); 
        document.getElementById('ship-preview-container').classList.remove('hidden');
        document.getElementById('bs-reset-btn').classList.add('hidden'); 
        document.getElementById('bs-controls-container').classList.remove('hidden');
        document.getElementById('bs-cpu-board-container').classList.add('hidden');
        
        document.getElementById('status-bar').style.background = "#333"; 
        document.getElementById('status-bar').textContent = "System Ready.";
        document.getElementById('enemy-board-title').textContent = mode==='cpu'?"Enemy Waters (CPU)":"Enemy Waters (P2P)";
        if(mode !== 'cpu') bs_turn = isHost;

        bs_updateStatus(); bs_updatePreview(); 
        document.getElementById('bs-rotate-btn').innerHTML = "â†» Rotate";
        bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true); 
        bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
    }

    function bs_rotate() { bs_isHoriz = !bs_isHoriz; bs_updatePreview(); }

    function bs_updateStatus() { 
        if(bs_state==='placement') document.getElementById('status-bar').textContent = `Deploying: ${bs_pShips[bs_shipIdx].name} (${bs_pShips[bs_shipIdx].size})`; 
    }
    
    function bs_updatePreview() {
        let el = document.getElementById('ship-preview-grid');
        el.innerHTML = '';
        if(bs_state!=='placement') { document.getElementById('ship-preview-container').classList.add('hidden'); return; }
        const s = bs_pShips[bs_shipIdx].size;
        el.style.gridTemplateColumns = bs_isHoriz ? `repeat(${s}, 9px)` : `9px`;
        el.style.gridTemplateRows = bs_isHoriz ? `9px` : `repeat(${s}, 9px)`;
        for(let i=0; i<s; i++) { let d = document.createElement('div'); d.className='preview-cell'; el.appendChild(d); }
    }

    function bs_render(el, data, isP) {
        el.innerHTML = ''; 
        el.className = `bs-grid ${isP&&bs_state==='placement'?'placement-mode':''} ${!isP&&bs_state==='combat'?'combat-mode':''}`;
        let h = document.createElement('div'); h.className='bs-header-cell'; el.appendChild(h);
        ['A','B','C','D','E','F','G','H','I','J'].forEach(l => { let d = document.createElement('div'); d.className='bs-header-cell'; d.textContent=l; el.appendChild(d); });
        for(let r=0; r<BS_SIZE; r++) {
            let rowH = document.createElement('div'); rowH.className='bs-header-cell'; rowH.textContent=r+1; el.appendChild(rowH);
            for(let c=0; c<BS_SIZE; c++) {
                let cell = document.createElement('div'); cell.className = 'bs-cell'; let v = data[r][c];
                if(isP && v===1) cell.classList.add('ship'); if(v===2) cell.classList.add('miss'); if(v===3) cell.classList.add('ship','hit');
                if(isP && bs_state==='placement') cell.onclick = ()=>bs_place(r,c);
                else if(!isP && bs_state==='combat') cell.onclick = ()=>bs_attack(r,c);
                el.appendChild(cell);
            }
        }
    }

    function bs_place(r, c) {
        if(bs_state!=='placement') return;
        const s = bs_pShips[bs_shipIdx].size;
        if(bs_canPlace(bs_pBoard,r,c,s,bs_isHoriz)) {
            let newShip = { name: bs_pShips[bs_shipIdx].name, size: s, hits: 0, coords: [] };
            for(let i=0; i<s; i++) {
                let rp = bs_isHoriz ? r : r+i; let cp = bs_isHoriz ? c+i : c;
                bs_pBoard[rp][cp] = 1; newShip.coords.push({r:rp, c:cp});
            }
            bs_pFleet.push(newShip); bs_shipIdx++; 
            bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
            if(bs_shipIdx >= bs_pShips.length) {
                document.getElementById('bs-rotate-btn').classList.add('hidden'); 
                document.getElementById('ship-preview-container').classList.add('hidden'); 
                document.getElementById('bs-controls-container').classList.add('hidden');
                document.getElementById('bs-cpu-board-container').classList.remove('hidden');
                if(gameMode==='cpu') { 
                    bs_state='combat'; gameInProgress = true; 
                    bs_cpuDeploy(); 
                    bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false); 
                    document.getElementById('status-bar').textContent="Combat Active!"; 
                } else { 
                    document.getElementById('status-bar').textContent="Fleet Ready. Waiting for opponent..."; 
                    dataChan.send(JSON.stringify({type:'READY'})); bs_checkP2P(); 
                }
            } else { bs_updateStatus(); bs_updatePreview(); }
        }
    }

    function bs_canPlace(b,r,c,s,h) {
        if(h) { if(c+s>10) return false; for(let i=0;i<s;i++) if(b[r][c+i]!==0) return false; } 
        else { if(r+s>10) return false; for(let i=0;i<s;i++) if(b[r+i][c]!==0) return false; }
        return true;
    }

    function bs_cpuDeploy() {
        bs_cShips.forEach(s => {
            let placed=false; 
            while(!placed) {
                let r=Math.floor(Math.random()*10); let c=Math.floor(Math.random()*10); let h=Math.random()>.5;
                if(bs_canPlace(bs_cBoard,r,c,s.size,h)) {
                    let ns = { name: s.name, size: s.size, hits: 0, coords: [] };
                    for(let i=0;i<s.size;i++) {
                        let rp = h ? r : r+i; let cp = h ? c+i : c;
                        bs_cBoard[rp][cp] = 1; ns.coords.push({r:rp, c:cp});
                    }
                    bs_cFleet.push(ns); placed=true;
                }
            }
        });
    }

    function bs_notifyGood(msg) { let el=document.getElementById('notify-right'); el.textContent = msg; el.classList.add('glow-green'); }
    function bs_notifyBad(msg) { let el=document.getElementById('notify-left'); el.textContent = msg; el.classList.add('glow-red'); }

    function bs_attack(r, c) {
        if(bs_state!=='combat' || !bs_turn) return; if(bs_cBoard[r][c]>1) return;
        if(gameMode==='cpu') {
            let hit = bs_cBoard[r][c] === 1; let sunk = false; let sunkName = '';
            bs_cBoard[r][c] = hit ? 3 : 2;
            if(hit) {
                let t = bs_cFleet.find(s=>s.coords.some(k=>k.r===r && k.c===c));
                if(t) { t.hits++; if(t.hits>=t.size) { sunk=true; sunkName=t.name; playSinkSound(); } }
            }
            bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
            if(hit && bs_cFleet.every(s=>s.hits>=s.size)) { bs_end(true); } 
            else { 
                bs_turn=false; 
                if(sunk) bs_notifyGood(`ENEMY ${sunkName} SUNK!`);
                document.getElementById('status-bar').textContent = sunk ? `SUNK! ${sunkName}` : (hit?"HIT!":"Miss."); 
                setTimeout(bs_cpuTurn, 1000); 
            }
        } else {
            dataChan.send(JSON.stringify({type:'ATTACK',r,c})); bs_turn=false; document.getElementById('status-bar').textContent="Firing...";
        }
    }

    function bs_cpuTurn() {
        let r, c, coords;
        if(bs_ai.mode === 'HUNT') coords = bs_randCoords();
        else if(bs_ai.mode === 'TARGET' || bs_ai.mode === 'KILL') {
            if(bs_ai.targets.length > 0) coords = bs_ai.targets.pop(); else { bs_ai.mode = 'HUNT'; coords = bs_randCoords(); }
        }
        if(bs_pBoard[coords.r][coords.c] > 1) { coords = bs_randCoords(); bs_ai.mode = 'HUNT'; }
        r=coords.r; c=coords.c;
        
        let hit = bs_pBoard[r][c] === 1; let sunk = false; let sunkName = ''; bs_pBoard[r][c] = hit ? 3 : 2;
        if(hit) {
            let t = bs_pFleet.find(s=>s.coords.some(k=>k.r===r && k.c===c));
            if(t) { t.hits++; if(t.hits>=t.size) { sunk=true; sunkName=t.name; playSinkSound(); } }
            if(sunk) { 
                bs_notifyBad(`LOST ${sunkName}!`); bs_ai.mode='HUNT'; bs_ai.targets=[]; bs_ai.firstHit=null; 
            } else {
                if(bs_ai.mode==='HUNT') { bs_ai.mode='TARGET'; bs_ai.firstHit={r,c}; bs_addTargs(r,c); }
                else if(bs_ai.mode==='TARGET') { bs_ai.mode='KILL'; bs_filterTargs(bs_ai.firstHit,{r,c}); bs_addNext(r,c,bs_ai.firstHit); }
                else if(bs_ai.mode==='KILL') { bs_addNext(r,c,bs_ai.firstHit); }
            }
        }
        bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
        if(hit && bs_pFleet.every(s=>s.hits>=s.size)) { bs_end(false); } else { bs_turn=true; document.getElementById('status-bar').textContent = "Your Turn"; }
    }
    
    function bs_randCoords() { let r,c,t=0; do{r=Math.floor(Math.random()*10);c=Math.floor(Math.random()*10);t++}while(bs_pBoard[r][c]>1&&t<200); return {r,c}; }
    function bs_addTargs(r,c) { [{r:-1,c:0},{r:1,c:0},{r:0,c:-1},{r:0,c:1}].sort(()=>Math.random()-.5).forEach(d=>{ let nr=r+d.r, nc=c+d.c; if(nr>=0&&nr<10&&nc>=0&&nc<10&&bs_pBoard[nr][nc]<2) bs_ai.targets.push({r:nr,c:nc}); }); }
    function bs_filterTargs(h1, h2) { let horiz = h1.r === h2.r; bs_ai.targets = bs_ai.targets.filter(t => horiz ? t.r===h1.r : t.c===h1.c); }
    function bs_addNext(cr, cc, orig) { let dr=0, dc=0; if(cr>orig.r)dr=1; else if(cr<orig.r)dr=-1; if(cc>orig.c)dc=1; else if(cc<orig.c)dc=-1; let nr=cr+dr, nc=cc+dc; if(nr>=0&&nr<10&&nc>=0&&nc<10&&bs_pBoard[nr][nc]<2) bs_ai.targets.push({r:nr,c:nc}); }

    function bs_end(won) {
        bs_state='gameover'; gameInProgress = false;
        document.getElementById('status-bar').textContent = won ? "VICTORY!" : "DEFEAT!";
        document.getElementById('status-bar').style.background = won ? "green" : "#b30000";
        document.getElementById('bs-reset-btn').classList.remove('hidden'); 
        document.getElementById('bs-controls-container').classList.remove('hidden');
        if(gameMode==='cpu') { stats.battleship.p++; if(won) stats.battleship.w++; localStorage.setItem('bs_played', stats.battleship.p); localStorage.setItem('bs_won', stats.battleship.w); }
    }

    // --- GRAVITRIPS ---
    const G_ROWS = 6, G_COLS = 7;
    let grav_board=[], grav_turn=1, grav_myId=1, grav_locked=false;
    
    function grav_init(mode) {
        gameMode = mode; 
        grav_board = Array(G_ROWS).fill(null).map(()=>Array(G_COLS).fill(0));
        grav_locked = false; grav_myId = (mode==='p2p'&&!isHost) ? 2 : 1; grav_turn = 1; gameInProgress = false;
        
        let grid = document.getElementById('grav-grid'); grid.innerHTML='';
        for(let r=0;r<G_ROWS;r++) for(let c=0;c<G_COLS;c++) { let d=document.createElement('div'); d.className='grav-cell'; d.dataset.r=r; d.dataset.c=c; d.onclick=()=>grav_drop(c); grid.appendChild(d); }
        let arrows = document.getElementById('grav-arrows'); arrows.innerHTML='';
        for(let c=0;c<G_COLS;c++) { let a=document.createElement('div'); a.className='grav-arrow'; a.textContent='â–¼'; a.onclick=()=>grav_drop(c); arrows.appendChild(a); }
        grav_updStat();
    }

    function grav_drop(col) {
        if(grav_locked || grav_turn!==grav_myId) return;
        for(let r=G_ROWS-1;r>=0;r--) { if(grav_board[r][col]===0) { gameInProgress = true; grav_anim(r,col,grav_myId); if(gameMode==='p2p') dataChan.send(JSON.stringify({type:'MOVE',col,p:grav_myId})); return; }}
    }

    function grav_anim(r,c,p) {
        grav_locked = true; grav_board[r][c] = p;
        let cell = document.querySelector(`.grav-cell[data-r="${r}"][data-c="${c}"]`);
        cell.classList.add(p===1?'p1':'p2');
        setTimeout(()=>{ 
            if(grav_checkWin(p)) grav_end(p===grav_myId); 
            else if(grav_board.every(row=>row.every(k=>k!==0))) { document.getElementById('status-bar').textContent="DRAW"; } 
            else { grav_turn = p===1?2:1; grav_locked=false; grav_updStat(); if(gameMode==='cpu' && grav_turn===2) { grav_locked=true; setTimeout(grav_cpu, 500); }}
        },400);
    }

    function grav_cpu() { 
        let col = -1; 
        for(let c=0; c<G_COLS; c++) if(grav_sim(c,2)) { col=c; break; } 
        if(col<0) for(let c=0; c<G_COLS; c++) if(grav_sim(c,1)) { col=c; break; } 
        if(col<0) { let a=[]; for(let c=0;c<G_COLS;c++) if(grav_board[0][c]===0) a.push(c); col=a[Math.floor(Math.random()*a.length)]; } 
        for(let r=G_ROWS-1;r>=0;r--) if(grav_board[r][col]===0) { grav_anim(r,col,2); break; } 
    }

    function grav_sim(c,p) { 
        if(grav_board[0][c]!==0) return false; let r; for(r=G_ROWS-1;r>=0;r--) if(grav_board[r][c]===0) break; 
        grav_board[r][c]=p; let w=grav_checkWin(p); grav_board[r][c]=0; return w; 
    }

    function grav_checkWin(p) { 
        for(let r=0;r<G_ROWS;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r][c+1]==p&&grav_board[r][c+2]==p&&grav_board[r][c+3]==p) return true; 
        for(let r=0;r<G_ROWS-3;r++) for(let c=0;c<G_COLS;c++) if(grav_board[r][c]==p&&grav_board[r+1][c]==p&&grav_board[r+2][c]==p&&grav_board[r+3][c]==p) return true; 
        for(let r=3;r<G_ROWS;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r-1][c+1]==p&&grav_board[r-2][c+2]==p&&grav_board[r-3][c+3]==p) return true; 
        for(let r=0;r<G_ROWS-3;r++) for(let c=0;c<G_COLS-3;c++) if(grav_board[r][c]==p&&grav_board[r+1][c+1]==p&&grav_board[r+2][c+2]==p&&grav_board[r+3][c+3]==p) return true; 
        return false; 
    }

    function grav_end(won) { 
        grav_locked=true; gameInProgress = false; 
        document.getElementById('status-bar').textContent = won?"VICTORY!":"DEFEAT!"; 
        document.getElementById('status-bar').style.background = won?"green":"#b30000"; 
        if(gameMode==='cpu') { stats.gravitrips.p++; if(won) stats.gravitrips.w++; localStorage.setItem('grav_played',stats.gravitrips.p); localStorage.setItem('grav_won',stats.gravitrips.w); } 
    }

    function grav_updStat() { 
        if(grav_turn===grav_myId) { document.getElementById('status-bar').textContent="YOUR TURN"; document.getElementById('status-bar').style.background="#333"; } 
        else { document.getElementById('status-bar').textContent = gameMode==='cpu' ? "CPU TURN" : "ENEMY TURN"; } 
    }

    // --- SOS ---
    const S_ROWS = 7, S_COLS = 8;
    let sos_board=[], sos_turn=1, sos_myId=1, sos_scores={1:0, 2:0}, sos_sel='S', sos_locked=false;
    
    function sos_init(mode) {
        gameMode = mode; 
        sos_board = Array(S_ROWS).fill(null).map(()=>Array(S_COLS).fill(null));
        sos_locked = false; sos_myId = (mode==='p2p'&&!isHost) ? 2 : 1; sos_turn = 1; 
        sos_scores={1:0, 2:0}; sos_sel='S'; gameInProgress = false;
        
        document.getElementById('sos-s1').textContent = "0"; 
        document.getElementById('sos-s2').textContent = "0"; 
        sos_setLetter('S'); sos_updStat();
        
        const grid = document.getElementById('sos-grid'); grid.innerHTML = '';
        for(let r=0;r<S_ROWS;r++) for(let c=0;c<S_COLS;c++) {
            let d = document.createElement('div'); d.className='sos-cell'; d.dataset.r=r; d.dataset.c=c;
            d.onclick=()=>sos_move(r,c); grid.appendChild(d);
        }
    }
    
    function sos_setLetter(l) { 
        sos_sel = l; 
        document.getElementById('btn-s').classList.toggle('active', l==='S');
        document.getElementById('btn-o').classList.toggle('active', l==='O');
    }

    function sos_move(r, c) {
        if(sos_locked || sos_board[r][c]!==null || sos_turn!==sos_myId) return;
        gameInProgress = true;
        sos_apply(r, c, sos_sel, sos_myId);
        if(gameMode === 'p2p') dataChan.send(JSON.stringify({type:'SOS_MOVE', r, c, l:sos_sel, p:sos_myId}));
    }

    function sos_apply(r, c, l, p) {
        sos_locked = true; sos_board[r][c] = l;
        let cell = document.querySelector(`.sos-cell[data-r="${r}"][data-c="${c}"]`);
        cell.textContent = l; cell.classList.add(`${l.toLowerCase()}-p${p}`);
        let pts = sos_checkPoints(r, c, l);
        sos_scores[p] += pts;
        document.getElementById(`sos-s${p}`).textContent = sos_scores[p];
        if(sos_board.every(row => row.every(cell => cell !== null))) { sos_end(); } 
        else { 
            if(pts === 0) sos_turn = (sos_turn===1)?2:1; 
            sos_updStat(); sos_locked = false; 
            if(gameMode === 'cpu' && sos_turn === 2) { sos_locked = true; setTimeout(sos_cpu, 500); }
        }
    }

    function sos_checkPoints(r, c, l) {
        let pts = 0;
        const g = (rr, cc) => (rr>=0 && rr<S_ROWS && cc>=0 && cc<S_COLS) ? sos_board[rr][cc] : '';
        if(l === 'S') {
            const dirs = [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
            dirs.forEach(([dr, dc]) => { if(g(r+dr, c+dc) === 'O' && g(r+dr*2, c+dc*2) === 'S') pts++; });
        } else { 
            if(g(r, c-1)==='S' && g(r, c+1)==='S') pts++;
            if(g(r-1, c)==='S' && g(r+1, c)==='S') pts++;
            if(g(r-1, c-1)==='S' && g(r+1, c+1)==='S') pts++;
            if(g(r-1, c+1)==='S' && g(r+1, c-1)==='S') pts++;
        }
        return pts;
    }

    function sos_cpu() {
        let best = null;
        for(let r=0; r<S_ROWS; r++) { for(let c=0; c<S_COLS; c++) { if(sos_board[r][c] === null) {
            sos_board[r][c] = 'S'; if(sos_checkPoints(r,c,'S') > 0) best = {r,c,l:'S'}; sos_board[r][c] = null; if(best) break;
            sos_board[r][c] = 'O'; if(sos_checkPoints(r,c,'O') > 0) best = {r,c,l:'O'}; sos_board[r][c] = null; if(best) break;
        }} if(best) break; }

        if(!best) {
            let empty = []; for(let r=0; r<S_ROWS; r++) for(let c=0; c<S_COLS; c++) if(sos_board[r][c]===null) empty.push({r,c});
            let pick = empty[Math.floor(Math.random()*empty.length)];
            best = {r:pick.r, c:pick.c, l: (Math.random()>.5?'S':'O')};
        }
        sos_apply(best.r, best.c, best.l, 2);
    }

    function sos_updStat() {
        if(sos_turn === sos_myId) { document.getElementById('status-bar').textContent = "YOUR TURN"; document.getElementById('status-bar').style.background = "#333"; }
        else { document.getElementById('status-bar').textContent = gameMode==='cpu' ? "CPU TURN" : "OPPONENT TURN"; }
    }

    function sos_end() {
        gameInProgress = false;
        let won = sos_scores[1] > sos_scores[2]; let draw = sos_scores[1] === sos_scores[2];
        if(draw) { document.getElementById('status-bar').textContent = "DRAW GAME!"; document.getElementById('status-bar').style.background = "#555"; }
        else {
            document.getElementById('status-bar').textContent = won ? "VICTORY!" : "DEFEAT!"; document.getElementById('status-bar').style.background = won ? "green" : "#b30000";
            if(gameMode==='cpu') { stats.sos.p++; if(won) stats.sos.w++; localStorage.setItem('sos_played',stats.sos.p); localStorage.setItem('sos_won',stats.sos.w); }
        }
    }

    // --- P2P SHARED LOGIC ---
    function openP2P() {
        closeModals(); 
        document.getElementById('p2p-modal').style.display='flex';
        document.getElementById('qrcode').innerHTML = '<span class="gen-anim">Generating...</span><div id="qr-hint">Tap anywhere to minimize</div>';
        isHost=true; 
        setupWebRTC();
        if(activeGame && stats[activeGame]) {
            let s = stats[activeGame];
            document.getElementById('stats-area').textContent = `${activeGame.toUpperCase()} vs CPU: Won ${s.w} / ${s.p}`;
        }
    }

    function setupWebRTC() {
        if(peerConn) { peerConn.close(); peerConn = null; }
        peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        
        peerConn.onicecandidate = e => { 
            if(!e.candidate) { 
                let t = btoa(JSON.stringify(peerConn.localDescription)); 
                document.getElementById('local-token').value=t; 
                let qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '<div id="qr-hint">Tap anywhere to minimize</div>';
                try {
                    new QRCode(qrContainer, {
                        text: t,
                        width: 512,
                        height: 512,
                        correctLevel: QRCode.CorrectLevel.L
                    });
                } catch(err) {
                    qrContainer.innerHTML += "Error generating QR";
                }
            }
        };

        if(isHost) { 
            dataChan = peerConn.createDataChannel("game"); 
            setupChan(); 
            peerConn.createOffer().then(d=>peerConn.setLocalDescription(d)); 
        } else {
            peerConn.ondatachannel = e => { dataChan = e.channel; setupChan(); };
        }
    }

    function setupChan() {
        dataChan.onopen = () => { 
            closeModals(); isP2P=true; 
            if(activeGame==='battleship') bs_init('p2p'); 
            else if(activeGame==='gravitrips') grav_init('p2p'); 
            else sos_init('p2p'); 
        };
        dataChan.onmessage = e => {
            let msg = JSON.parse(e.data);
            if(activeGame==='battleship') bs_handleNet(msg);
            else if(msg.type==='MOVE') { 
                gameInProgress = true; 
                for(let r=G_ROWS-1;r>=0;r--) if(grav_board[r][msg.col]===0) { grav_anim(r,msg.col,msg.p); break; } 
            }
            else if(msg.type==='SOS_MOVE') { 
                gameInProgress = true; 
                sos_apply(msg.r, msg.c, msg.l, msg.p); 
            }
        };
    }

    function bs_checkP2P() { 
        if(bs_shipIdx>=5 && bs_p2pReady) { 
            bs_state='combat'; 
            gameInProgress = true; 
            bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false); 
            document.getElementById('status-bar').textContent=bs_turn?"YOUR TURN":"ENEMY TURN"; 
        } 
    }

    function bs_handleNet(msg) {
        if(msg.type==='READY') { bs_p2pReady=true; bs_checkP2P(); }
        else if(msg.type==='ATTACK') {
            let hit=false, sunk=false; let t=bs_pFleet.find(s=>s.coords.some(k=>k.r===msg.r && k.c===msg.c));
            if(t && bs_pBoard[msg.r][msg.c]!==3) { 
                bs_pBoard[msg.r][msg.c]=3; hit=true; t.hits++; 
                if(t.hits>=t.size) { sunk=true; playSinkSound(); }
            } else if(!t) bs_pBoard[msg.r][msg.c]=2;
            bs_render(document.getElementById('bs-player-grid'), bs_pBoard, true);
            dataChan.send(JSON.stringify({type:'RESULT',r:msg.r,c:msg.c,hit,sunk,sunkName:t?t.name:''}));
            if(sunk) bs_notifyBad(`LOST ${t.name}!`);
            if(bs_pFleet.every(s=>s.hits>=s.size)) { dataChan.send(JSON.stringify({type:'GAMEOVER'})); bs_end(false); } else { bs_turn=true; document.getElementById('status-bar').textContent="YOUR TURN"; }
        }
        else if(msg.type==='RESULT') {
            bs_cBoard[msg.r][msg.c] = msg.hit?3:2; bs_render(document.getElementById('bs-cpu-grid'), bs_cBoard, false);
            if(msg.sunk) { bs_notifyGood(`ENEMY ${msg.sunkName} SUNK!`); playSinkSound(); }
            else if(msg.hit) document.getElementById('status-bar').textContent="HIT!"; else document.getElementById('status-bar').textContent="Miss.";
        }
        else if(msg.type==='GAMEOVER') bs_end(true);
    }

    function processRemote() {
        let txt = document.getElementById('remote-token').value; if(!txt)return;
        try {
            let desc = JSON.parse(atob(txt));
            if(desc.type==='offer') {
                if(peerConn) peerConn.close(); 
                isHost=false;
                peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                peerConn.onicecandidate = e => { 
                    if(!e.candidate) { 
                        let t = btoa(JSON.stringify(peerConn.localDescription)); 
                        document.getElementById('local-token').value=t; 
                        document.getElementById('qrcode').innerHTML = '<div id="qr-hint">Tap anywhere to minimize</div>';
                        new QRCode(document.getElementById('qrcode'),{text:t,width:512,height:512}); 
                    }
                };
                peerConn.ondatachannel = e => { dataChan = e.channel; setupChan(); };
                peerConn.setRemoteDescription(desc); 
                peerConn.createAnswer().then(d=>peerConn.setLocalDescription(d));
            } else {
                peerConn.setRemoteDescription(desc);
            }
        } catch(e){alert("Invalid Code");}
    }

    function toggleScan() {
        let btn = document.getElementById('cam-toggle-btn');
        if(isScanning) { 
            html5QrCode.stop().then(() => {
                isScanning = false; 
                document.getElementById('reader').classList.add('hidden'); 
                btn.textContent = "ðŸ“· Toggle Camera";
                btn.classList.remove('active');
            }).catch(err => {
                console.error("Failed to stop scanning", err);
                isScanning = false;
                document.getElementById('reader').classList.add('hidden');
                btn.textContent = "ðŸ“· Toggle Camera";
            });
        } else {
            document.getElementById('reader').classList.remove('hidden'); 
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, (txt) => { 
                document.getElementById('remote-token').value = txt; 
                toggleScan(); 
                processRemote(); 
            });
            isScanning = true;
            btn.textContent = "â¹ Stop Camera";
            btn.classList.add('active');
        }
    }

    function toggleQRZoom() {
        document.getElementById('qrcode').classList.toggle('qr-fullscreen');
    }

</script>
</body>
</html>