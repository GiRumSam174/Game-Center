<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Euchre 1v1</title>

<link rel="manifest" href="manifest.json">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1b5e20">

<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root {
    --bg-color: #1b5e20; 
    --card-width: 75px;
    --card-height: 108px;
    --card-radius: 8px;
    --card-overlap: -40px;
  }
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: var(--bg-color);
    color: white;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    height: 100dvh; 
    overflow: hidden;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* --- HEADER --- */
  header {
    width: 100%;
    height: 50px;
    padding: 0 15px;
    background: rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between; 
    align-items: center;
    box-sizing: border-box;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-size: 1rem;
    z-index: 10;
    flex-shrink: 0;
    position: relative; 
    padding-top: env(safe-area-inset-top);
  }
  
  .game-title { 
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold; 
      color: #ffca28; 
      font-size: 1.1rem; 
      white-space: nowrap;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      text-transform: uppercase;
      cursor: pointer;
  }
  
  .score-text { 
      font-weight: bold; 
      color: white;
      display: flex;
      gap: 5px;
      font-size: 0.9rem;
      min-width: 60px;
  }
  
  /* --- GAME AREA --- */
  #game-area {
    flex: 1;
    width: 100%;
    max-width: 900px;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    padding: 10px 0 30px 0; 
    box-sizing: border-box;
    padding-bottom: calc(30px + env(safe-area-inset-bottom));
  }

  /* --- TRUMP INDICATOR --- */
  .trump-display {
      position: relative;
      margin: 5px auto; 
      background: rgba(0,0,0,0.4);
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.85rem;
      display: flex;
      flex-direction: row; 
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(255,255,255,0.2);
      z-index: 5;
      width: fit-content;
  }
  .trump-icon { font-size: 1.5rem; line-height: 1; }
  .bid-info { font-size: 0.85rem; color: #eee; }
  .trick-info { color: #ffca28; font-weight:bold; font-size: 0.9rem; margin-left: 5px; border-left: 1px solid #666; padding-left: 15px;}

  /* --- HANDS --- */
  .hand-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    z-index: 5;
    transition: opacity 0.2s;
  }
  
  .hand-container.locked {
      pointer-events: none !important;
      opacity: 0.8;
      filter: grayscale(0.3);
  }
  
  .hand {
    display: flex;
    justify-content: center; 
    align-items: center;
    height: 120px;
    position: relative;
    padding: 0 10px;
    width: 100%;
    box-sizing: border-box;
  }
  
  /* --- CARD VISUALS --- */
  .card {
    width: var(--card-width);
    height: var(--card-height);
    background: white;
    border-radius: var(--card-radius);
    color: black;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    position: relative;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    font-size: 1.2rem;
    transition: transform 0.2s, margin-top 0.2s; 
    z-index: 1;
    flex-shrink: 0;
  }

  .hand .card { margin-right: var(--card-overlap); }
  .hand .card:last-child { margin-right: 0; }
  
  @media (hover: hover) {
    #player-hand .card.playable:hover { margin-top: -20px; z-index: 100; transform: scale(1.05); }
  }

  .card.red { color: #d32f2f; }
  .card.black { color: #212121; }
  
  .card .corner { position: absolute; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; line-height: 0.9;}
  .card .top-left { top: 5px; left: 5px; }
  .card .bottom-right { bottom: 5px; right: 5px; transform: rotate(180deg); }
  .card .suit-center { font-size: 2.5rem; }

  #computer-hand .card { 
      background: #0d47a1; 
      border: 2px solid white;
      transform: scale(0.9);
      cursor: default;
  }
  
  .dimmed { filter: brightness(0.6); pointer-events: none; }
  .card:not(.playable) { filter: brightness(0.85); cursor: not-allowed; }

  /* --- TABLE AREA --- */
  .table-center {
    display: flex;
    justify-content: center;
    gap: 20px;
    align-items: center;
    height: 160px;
    z-index: 5;
    flex-shrink: 0;
    position: relative;
  }
  
  .trick-slot {
      width: var(--card-width);
      height: var(--card-height);
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: var(--card-radius);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
  }
  
  .trick-card {
      position: absolute;
      top: 0; left: 0;
      transition: all 0.5s ease-out;
  }

  /* --- ANIMATION LAYER --- */
  #animation-layer {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
  }
  .flying-card {
      position: absolute;
      transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      box-shadow: 5px 5px 20px rgba(0,0,0,0.5) !important;
  }

  /* --- CONTROLS / UI PANELS --- */
  #controls-area {
    position: absolute;
    bottom: 160px; 
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    z-index: 200;
    flex-direction: column;
    gap: 10px;
  }

  .action-panel {
      background: rgba(0,0,0,0.85);
      padding: 15px 20px;
      border-radius: 12px;
      pointer-events: auto;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid #555;
      animation: popIn 0.2s ease-out;
      width: 90%; 
      max-width: 400px;
  }

  .btn-group { 
      display: flex; 
      gap: 5px; 
      justify-content: center; 
      flex-wrap: nowrap;
      margin-top: 10px; 
      width: 100%;
  }

  button {
    padding: 12px 0; 
    font-size: 1rem; 
    background: #ffca28;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #333;
    transition: transform 0.1s;
    flex: 1;
    min-width: 0;
  }
  button:active { transform: scale(0.95); background: #ffb300; }
  
  .suit-btn { font-size: 1.5rem; line-height: 1; }
  .suit-btn.red { color: #d32f2f; }
  .suit-btn.black { color: #212121; }

  /* --- OVERLAYS --- */
  .overlay-bg {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); 
    display: none;
    z-index: 999;
    justify-content: center;
    align-items: center;
  }
  
  .status-box {
    background: rgba(51, 51, 51, 0.98);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    border: 2px solid #ffca28;
    max-width: 340px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
    animation: popIn 0.3s ease-out;
    position: relative;
  }
  
  @keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  h2 { margin-top: 0; color: #ffca28; font-size: 1.4rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
  
  #overlay-content { font-size: 1rem; line-height: 1.5; color: #eee; margin-bottom: 20px;}
  
  #toast {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.85);
    color: #ffca28;
    padding: 12px 25px;
    border-radius: 30px;
    font-weight: bold;
    pointer-events: none;
    display: none;
    z-index: 150;
    white-space: nowrap; 
    border: 1px solid #555;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    font-size: 1.1rem;
  }

  /* Info Modal Specifics */
  .info-text { text-align: left; font-size: 0.9rem; line-height: 1.5; color: #ccc; margin: 15px 0; background:rgba(255,255,255,0.1); padding:10px; border-radius:6px; }
  .info-text strong { color: #ffca28; }
  
  .modal-actions { 
      display: flex; 
      gap: 5px; 
      justify-content: center; 
      margin-top: 15px; 
      width: 100%;
  }
  .modal-btn { 
      padding: 10px 4px; 
      font-size: 0.75rem; 
      flex: 1; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
  }
  .secondary { background: #eee; color: #333; }
  .coffee-btn { background: #FFDD00; color: #000; }
  .game-over-btn { background: #4caf50; color: white; }
</style>
</head>
<body>

<header>
  <div class="score-text">CPU: <span id="c-score">0</span></div>
  <div class="game-title" onclick="openInfo()">EUCHRE</div>
  <div class="score-text">YOU: <span id="p-score">0</span></div>
</header>

<div id="toast">Your Turn</div>
<div id="animation-layer"></div>

<div id="status-overlay" class="overlay-bg">
  <div class="status-box">
    <h2 id="overlay-title">Round Over</h2>
    <div id="overlay-content"></div>
    <button id="overlay-btn" class="modal-btn" style="flex:none; width:auto; padding:10px 30px; font-size: 1rem;" onclick="nextRound()">Next Round</button>
  </div>
</div>

<div id="info-overlay" class="overlay-bg">
    <div class="status-box" style="width: 95%; max-width:380px; padding: 15px;">
        <h2>EUCHRE <span style="font-size:0.8rem; color:#aaa; vertical-align:middle;">v2.1</span></h2>
        
        <div class="info-text" style="font-size:0.8rem;">
            <strong>Rank:</strong> A, K, Q, J, 10, 9.<br>
            <strong>Exceptions:</strong><br>
            • Right Bower (Jack of Trump) is High.<br>
            • Left Bower (Jack of same color) is 2nd.<br>
            • Other Jacks rank below Queens.
        </div>
        
        <div id="stats-display" style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem; color:#ddd;">
           </div>

        <div class="modal-actions">
            <button class="modal-btn" onclick="confirmReset()">New Game</button>
            <button class="modal-btn coffee-btn" onclick="window.open('https://buymeacoffee.com/classmarks','_blank')">Buy Me A Coffee</button>
            <button class="modal-btn secondary" onclick="closeInfo()">Close</button>
        </div>
    </div>
</div>

<div id="game-area">
  <div class="hand-container">
    <div class="hand" id="computer-hand"></div>
  </div>

  <div id="trump-indicator" class="trump-display" style="display:none">
      <div id="trump-icon" class="trump-icon"></div>
      <div id="bid-status" class="bid-info"></div>
      <div id="tricks-status" class="trick-info"></div>
  </div>

  <div class="table-center" id="table-center">
    <div class="trick-slot" id="slot-cpu"></div>
    <div class="trick-slot" id="slot-player"></div>
  </div>

  <div id="controls-area">
      <div id="bid-panel" class="action-panel" style="display:none;">
          <div style="color:#eee; margin-bottom:5px;">Select your Bid</div>
          <div class="btn-group">
              <button onclick="submitBid(0)">Pass</button>
              <button onclick="submitBid(1)">1</button>
              <button onclick="submitBid(2)">2</button>
              <button onclick="submitBid(3)">3</button>
              <button onclick="submitBid(4)">4</button>
              <button onclick="submitBid(5)">5</button>
          </div>
      </div>

      <div id="suit-panel" class="action-panel" style="display:none;">
        <div style="color:#eee; margin-bottom:5px;">Name Trump</div>
        <div class="btn-group">
            <button class="suit-btn black" onclick="selectTrump('♠')">♠</button>
            <button class="suit-btn black" onclick="selectTrump('♣')">♣</button>
            <button class="suit-btn red" onclick="selectTrump('♥')">♥</button>
            <button class="suit-btn red" onclick="selectTrump('♦')">♦</button>
        </div>
      </div>
  </div>

  <div class="hand-container" id="hand-container-player">
    <div class="hand" id="player-hand"></div>
  </div>
</div>

<script>
/* --- CONSTANTS & CONFIG --- */
const SUITS = ['♠', '♥', '♣', '♦'];
const COLORS = {'♠':'black', '♣':'black', '♥':'red', '♦':'red'};
const VALUES = ['9', '10', 'J', 'Q', 'K', 'A'];
const RANK_ORDER = { '9':0, '10':1, 'J':2, 'Q':3, 'K':4, 'A':5 };
const TARGET_SCORE = 10;

/* --- STATE VARIABLES --- */
let deck = [];
let playerHand = [];
let cpuHand = [];
let playerScore = 0;
let cpuScore = 0;

// Round Specifics
let currentBidder = null; 
let winningBid = 0;
let maker = null; 
let trumpSuit = null;
let tricksPlayer = 0;
let tricksCpu = 0;
let tricksPlayed = 0;
let currentTrickCards = []; 
let leadSuit = null;
let turn = null;
let isRoundOver = false;

// Timers
let uiTimer = null;

/* --- DOM ELEMENTS --- */
const elPlayerHand = document.getElementById('player-hand');
const elHandContainer = document.getElementById('hand-container-player');
const elCpuHand = document.getElementById('computer-hand');
const elSlotPlayer = document.getElementById('slot-player');
const elSlotCpu = document.getElementById('slot-cpu');
const elBidPanel = document.getElementById('bid-panel');
const elSuitPanel = document.getElementById('suit-panel');
const elOverlay = document.getElementById('status-overlay');
const elInfoOverlay = document.getElementById('info-overlay');
const elStatsDisplay = document.getElementById('stats-display');
const elTrumpDisplay = document.getElementById('trump-indicator');
const elTrumpIcon = document.getElementById('trump-icon');
const elBidStatus = document.getElementById('bid-status');
const elTrickStatus = document.getElementById('tricks-status');
const elToast = document.getElementById('toast');
const elOverlayBtn = document.getElementById('overlay-btn');

/* --- STATS LOGIC --- */
let stats = {
    handsPlayed: 0,
    handsWon: 0,
    matchesPlayed: 0,
    matchesWon: 0
};

function loadStats() {
    const s = localStorage.getItem('euchre-stats-v1');
    if(s) stats = JSON.parse(s);
}
function saveStats() {
    localStorage.setItem('euchre-stats-v1', JSON.stringify(stats));
}
loadStats();

/* --- INPUT LOCKING SYSTEM --- */
function updateInputLock() {
    if(turn !== 'player' || isRoundOver) {
        elHandContainer.classList.add('locked');
    } else {
        elHandContainer.classList.remove('locked');
    }
}

/* --- INITIALIZATION --- */
function confirmReset() {
    if(confirm('Quit current game and start over?')) {
        closeInfo();
        resetGame();
    }
}

function resetGame() {
    playerScore = 0;
    cpuScore = 0;
    closeInfo();
    updateScoreUI();
    startRound();
}

function startRound() {
    isRoundOver = false;
    currentBidder = 'player';
    winningBid = 0;
    maker = null;
    trumpSuit = null;
    tricksPlayer = 0;
    tricksCpu = 0;
    tricksPlayed = 0;
    currentTrickCards = [];
    leadSuit = null;
    
    turn = null; 
    updateInputLock();
    
    // UI Cleanup
    elOverlay.style.display = 'none';
    elTrumpDisplay.style.display = 'none';
    elBidPanel.style.display = 'none';
    elSuitPanel.style.display = 'none';
    elSlotPlayer.innerHTML = '';
    elSlotCpu.innerHTML = '';
    
    createDeck();
    dealHands();
    renderHands();
    
    showToast("Bidding Phase");
    startBidding();
}

/* --- DECK & DEAL --- */
function createDeck() {
    deck = [];
    for(let s of SUITS) {
        for(let v of VALUES) {
            deck.push({
                val: v, suit: s, 
                color: COLORS[s],
                id: Math.random().toString(36).substr(2, 9)
            });
        }
    }
    for(let i=deck.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

function dealHands() {
    playerHand = deck.slice(0, 5);
    cpuHand = deck.slice(5, 10);
    sortHand(playerHand);
    sortHand(cpuHand);
}

function sortHand(hand) {
    hand.sort((a,b) => {
        if(a.suit !== b.suit) return SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit);
        return RANK_ORDER[a.val] - RANK_ORDER[b.val];
    });
}

/* --- BIDDING PHASE --- */
function startBidding() {
    elBidPanel.style.display = 'block';
}

function submitBid(amount) {
    elBidPanel.style.display = 'none';
    
    let pBid = amount;
    let cpuEst = evaluateHandStrength(cpuHand);
    let cBid = Math.round(cpuEst);
    if(cBid < 1) cBid = 0;
    
    let msg = "";
    if(pBid === 0 && cBid === 0) {
        showToast("Both Passed. Re-dealing...");
        setTimeout(startRound, 1200);
        return;
    }
    
    if(pBid >= cBid && pBid > 0) {
        winningBid = pBid;
        maker = 'player';
        turn = 'player'; 
        updateInputLock();
        msg = `You won bid (${pBid})`;
        showToast(msg);
        
        // Timer mgmt for panels
        if(uiTimer) clearTimeout(uiTimer);
        uiTimer = setTimeout(() => { elSuitPanel.style.display = 'block'; }, 800);
    } else {
        winningBid = cBid;
        maker = 'cpu';
        turn = 'cpu';
        updateInputLock();
        msg = `CPU bids ${cBid}`;
        showToast(msg);
        if(uiTimer) clearTimeout(uiTimer);
        uiTimer = setTimeout(cpuPickTrump, 1000);
    }
}

function evaluateHandStrength(hand) {
    let strength = 0;
    hand.forEach(c => {
        if(c.val === 'A') strength += 1.0;
        else if(c.val === 'K') strength += 0.6;
        else if(c.val === 'J') strength += 0.5; 
        else if(c.val === 'Q') strength += 0.3;
    });
    return strength;
}

/* --- TRUMP SELECTION --- */
function selectTrump(suit) {
    elSuitPanel.style.display = 'none';
    trumpSuit = suit;
    startPlayPhase();
}

function cpuPickTrump() {
    let counts = {'♠':0, '♥':0, '♣':0, '♦':0};
    cpuHand.forEach(c => {
        let val = 1;
        if(c.val === 'J') val = 3; 
        if(c.val === 'A') val = 2;
        counts[c.suit] += val;
    });
    let bestSuit = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    trumpSuit = bestSuit;
    showToast(`CPU chose ${trumpSuit}`);
    if(uiTimer) clearTimeout(uiTimer);
    uiTimer = setTimeout(startPlayPhase, 1200);
}

/* --- PLAY PHASE --- */
function startPlayPhase() {
    // FIX: Force hide panels to prevent glitches
    elBidPanel.style.display = 'none';
    elSuitPanel.style.display = 'none';
    if(uiTimer) clearTimeout(uiTimer);

    sortHandWithTrump(playerHand);
    sortHandWithTrump(cpuHand);
    renderHands();
    updateUIHeader();
    
    if(turn === 'cpu') {
        updateInputLock(); 
        setTimeout(cpuPlayCard, 1000);
    } else {
        showToast("Your Lead", true);
        highlightPlayableCards();
        updateInputLock();
    }
}

function updateUIHeader() {
    elTrumpDisplay.style.display = 'flex';
    elTrumpIcon.innerHTML = `<span style="color:${COLORS[trumpSuit]}">${trumpSuit}</span>`;
    elTrumpIcon.style.color = COLORS[trumpSuit];
    
    let makerName = maker === 'player' ? "YOU" : "CPU";
    elBidStatus.innerText = `${makerName} BID ${winningBid}`;
    updateTrickScore();
}

function updateTrickScore() {
    elTrickStatus.innerText = `You: ${tricksPlayer} | CPU: ${tricksCpu}`;
}

/* --- GAME LOGIC --- */
function getEffectiveSuit(card) {
    if(card.val === 'J') {
        if(card.suit === trumpSuit) return trumpSuit;
        let partnerSuit = "";
        if(trumpSuit === '♠') partnerSuit = '♣';
        if(trumpSuit === '♣') partnerSuit = '♠';
        if(trumpSuit === '♥') partnerSuit = '♦';
        if(trumpSuit === '♦') partnerSuit = '♥';
        if(card.suit === partnerSuit) return trumpSuit;
    }
    return card.suit;
}

function getCardPower(card, lead) {
    let suit = getEffectiveSuit(card);
    let isTrump = suit === trumpSuit;
    let isLead = suit === lead;
    let baseVal = RANK_ORDER[card.val];
    let score = baseVal;
    
    if(isTrump) {
        score += 20;
        if(card.val === 'J') {
             if(card.suit === trumpSuit) score = 27; 
             else score = 26;
        }
    } else if (isLead) {
        score += 10;
    }
    return score;
}

function sortHandWithTrump(hand) {
    hand.sort((a,b) => {
        let suitA = getEffectiveSuit(a);
        let suitB = getEffectiveSuit(b);
        let powerA = getCardPower(a, trumpSuit);
        let powerB = getCardPower(b, trumpSuit);
        
        if(suitA === trumpSuit && suitB === trumpSuit) return powerB - powerA;
        if(suitA === trumpSuit) return -1;
        if(suitB === trumpSuit) return 1;
        
        if(suitA !== suitB) return SUITS.indexOf(suitA) - SUITS.indexOf(suitB);
        return powerB - powerA;
    });
}

function isCardPlayable(card) {
    if(currentTrickCards.length === 0) return true;
    let leadCard = currentTrickCards[0].card;
    let leadS = getEffectiveSuit(leadCard);
    let hasLead = playerHand.some(c => getEffectiveSuit(c) === leadS);
    if(hasLead) return getEffectiveSuit(card) === leadS;
    return true;
}

function highlightPlayableCards() {
    const cards = document.querySelectorAll('#player-hand .card');
    cards.forEach((el, idx) => {
        let cardData = playerHand[idx];
        if(isCardPlayable(cardData)) {
            el.classList.add('playable');
            el.classList.remove('dimmed');
        } else {
            el.classList.remove('playable');
            el.classList.add('dimmed');
        }
    });
}

/* --- INTERACTION --- */
function onCardClick(idx) {
    if(turn !== 'player' || isRoundOver) return;
    
    let card = playerHand[idx];
    if(!isCardPlayable(card)) {
        showToast("Must follow suit!");
        return;
    }
    
    turn = null; 
    updateInputLock(); 
    
    playerHand.splice(idx, 1);
    renderHands();
    animatePlayCard(card, 'player', elPlayerHand, elSlotPlayer);
    
    currentTrickCards.push({owner:'player', card: card});
    
    if(currentTrickCards.length === 1) {
        leadSuit = getEffectiveSuit(card);
        turn = 'cpu'; 
        setTimeout(cpuPlayCard, 600);
    } else {
        resolveTrick(); 
    }
}

function cpuPlayCard() {
    let idx = -1;
    let cardToPlay = null;
    
    if(currentTrickCards.length === 0) {
        let bestScore = -1;
        cpuHand.forEach((c, i) => {
             let p = getCardPower(c, trumpSuit);
             if(p > bestScore) { bestScore = p; idx = i; }
        });
    } else {
        let leadCard = currentTrickCards[0].card;
        let leadS = getEffectiveSuit(leadCard);
        let candidates = [];
        
        cpuHand.forEach((c, i) => {
            if(getEffectiveSuit(c) === leadS) candidates.push(i);
        });
        
        if(candidates.length > 0) {
            let bestOfSuit = -1; 
            idx = candidates[0];
            let leadPower = getCardPower(leadCard, leadS);
            
            candidates.forEach(i => {
                let p = getCardPower(cpuHand[i], leadS);
                if(p > bestOfSuit) { bestOfSuit = p; idx = i; }
            });
            
            if(bestOfSuit < leadPower) {
                 let lowest = 100;
                 candidates.forEach(i => {
                    let p = getCardPower(cpuHand[i], leadS);
                    if(p < lowest) { lowest = p; idx = i; }
                 });
            }
        } else {
            let trumps = [];
            cpuHand.forEach((c, i) => {
                if(getEffectiveSuit(c) === trumpSuit) trumps.push(i);
            });
            if(trumps.length > 0) {
                 let lowestT = 100;
                 trumps.forEach(i => {
                    let p = getCardPower(cpuHand[i], leadS);
                    if(p < lowestT) { lowestT = p; idx = i; }
                 });
            } else {
                let lowest = 100;
                cpuHand.forEach((c, i) => {
                    let r = RANK_ORDER[c.val];
                    if(r < lowest) { lowest = r; idx = i; }
                });
            }
        }
    }
    
    cardToPlay = cpuHand.splice(idx, 1)[0];
    renderHands();
    animatePlayCard(cardToPlay, 'cpu', elCpuHand, elSlotCpu);
    
    currentTrickCards.push({owner:'cpu', card: cardToPlay});
    
    if(currentTrickCards.length === 1) {
        leadSuit = getEffectiveSuit(cardToPlay);
        turn = 'player';
        showToast("Your Turn", true);
        highlightPlayableCards();
        updateInputLock(); 
    } else {
        resolveTrick();
    }
}

function resolveTrick() {
    turn = null; 
    updateInputLock();
    
    setTimeout(() => {
        let c1 = currentTrickCards[0];
        let c2 = currentTrickCards[1];
        
        let leadS = getEffectiveSuit(c1.card);
        let p1 = getCardPower(c1.card, leadS);
        let p2 = getCardPower(c2.card, leadS);
        
        let winner = (p1 >= p2) ? c1.owner : c2.owner;
        
        if(winner === 'player') {
            tricksPlayer++;
            showToast("You won trick");
            turn = 'player';
        } else {
            tricksCpu++;
            showToast("CPU won trick");
            turn = 'cpu';
        }
        
        updateTrickScore();
        
        setTimeout(() => {
            elSlotPlayer.innerHTML = '';
            elSlotCpu.innerHTML = '';
            currentTrickCards = [];
            leadSuit = null;
            
            tricksPlayed++;
            
            if(tricksPlayed >= 5) {
                endRound();
            } else {
                if(turn === 'player') {
                    showToast("Your Lead", true);
                    highlightPlayableCards();
                    updateInputLock(); 
                } else {
                    updateInputLock(); 
                    cpuPlayCard();
                }
            }
        }, 800);
    }, 800);
}

function endRound() {
    isRoundOver = true;
    turn = null;
    updateInputLock(); 
    
    stats.handsPlayed++;
    
    let title = "";
    let msg = "";
    let isMaker = (maker === 'player');
    let makerTricks = isMaker ? tricksPlayer : tricksCpu;
    let bid = winningBid;
    let roundPoints = 0;
    let success = false;
    
    if(makerTricks >= bid) {
        success = true;
        roundPoints = bid; 
        if(maker === 'player') {
            playerScore += roundPoints;
            title = "Bid Made!";
            msg = `You bid ${bid} and took ${makerTricks}.<br><span style="color:#4caf50">+${roundPoints} Points</span>`;
        } else {
            cpuScore += roundPoints;
            title = "CPU Made Bid";
            msg = `CPU bid ${bid} and took ${makerTricks}.<br><span style="color:#f44336">CPU +${roundPoints} Points</span>`;
        }
    } else {
        roundPoints = bid; 
        if(maker === 'player') {
            cpuScore += roundPoints;
            title = "Euchred!";
            msg = `You bid ${bid} but only took ${makerTricks}.<br><span style="color:#f44336">CPU +${roundPoints} Points</span>`;
        } else {
            playerScore += roundPoints;
            title = "CPU Euchred!";
            msg = `CPU bid ${bid} but only took ${makerTricks}.<br><span style="color:#4caf50">You +${roundPoints} Points</span>`;
        }
    }
    
    let youWonHand = (isMaker && success) || (!isMaker && !success);
    if(youWonHand) stats.handsWon++;
    
    updateScoreUI();
    
    // Check Game Win Condition
    let isGameOver = (playerScore >= TARGET_SCORE || cpuScore >= TARGET_SCORE);
    
    if(isGameOver) {
        stats.matchesPlayed++;
        let pWin = playerScore >= TARGET_SCORE;
        if(pWin) stats.matchesWon++;
        
        title = pWin ? "YOU WIN!" : "GAME OVER";
        msg += `<br><br><strong style="font-size:1.2rem">${pWin ? "Match Victory!" : "Match Defeat"}</strong>`;
        
        // Critical: Change button to START NEW GAME so users don't think it's just next round
        elOverlayBtn.onclick = resetGame;
        elOverlayBtn.innerText = "START NEW GAME";
        elOverlayBtn.classList.add('game-over-btn');
    } else {
        elOverlayBtn.onclick = nextRound;
        elOverlayBtn.innerText = "Next Round";
        elOverlayBtn.classList.remove('game-over-btn');
    }
    
    document.getElementById('overlay-title').innerText = title;
    document.getElementById('overlay-content').innerHTML = msg;
    
    saveStats();
    elOverlay.style.display = 'flex';
}

function nextRound() {
    startRound();
}

function updateScoreUI() {
    document.getElementById('p-score').innerText = playerScore;
    document.getElementById('c-score').innerText = cpuScore;
}

/* --- RENDER --- */
function renderHands() {
    elPlayerHand.innerHTML = '';
    playerHand.forEach((c, i) => {
        let div = createCardDiv(c);
        div.onclick = () => onCardClick(i);
        elPlayerHand.appendChild(div);
    });
    
    elCpuHand.innerHTML = '';
    cpuHand.forEach(() => {
        let div = document.createElement('div');
        div.className = 'card';
        div.style.background = '#0d47a1';
        div.style.border = '2px solid white';
        elCpuHand.appendChild(div);
    });
}

function createCardDiv(c) {
    let div = document.createElement('div');
    div.className = `card ${c.color}`;
    div.innerHTML = `
        <div class="corner top-left"><span>${c.val}</span><span>${c.suit}</span></div>
        <div class="suit-center">${c.suit}</div>
        <div class="corner bottom-right"><span>${c.val}</span><span>${c.suit}</span></div>
    `;
    return div;
}

function animatePlayCard(cardData, who, sourceContainer, targetContainer) {
    let startRect = sourceContainer.getBoundingClientRect(); 
    const flyer = createCardDiv(cardData);
    flyer.classList.add('flying-card');
    flyer.style.top = (startRect.top + 20) + 'px';
    flyer.style.left = (startRect.left + startRect.width/2 - 35) + 'px';
    document.getElementById('animation-layer').appendChild(flyer);
    
    const destRect = targetContainer.getBoundingClientRect();
    flyer.offsetHeight; 
    flyer.style.top = destRect.top + 'px';
    flyer.style.left = destRect.left + 'px';
    
    setTimeout(() => {
        flyer.remove();
        let staticCard = createCardDiv(cardData);
        staticCard.classList.add('trick-card');
        targetContainer.appendChild(staticCard);
    }, 500);
}

function showToast(msg, persist=false) {
    elToast.innerHTML = msg;
    elToast.style.display = 'block';
    if(!persist) setTimeout(() => { elToast.style.display = 'none'; }, 2000);
}

/* --- MENU / STATS --- */
function openInfo() {
    let hw = stats.handsWon, hp = stats.handsPlayed;
    let mw = stats.matchesWon, mp = stats.matchesPlayed;
    let hPct = hp > 0 ? Math.round((hw/hp)*100) : 0;
    let mPct = mp > 0 ? Math.round((mw/mp)*100) : 0;
    
    let html = `
        <div><strong>Hands Won:</strong> ${hw}/${hp} (${hPct}%)</div>
        <div><strong>Matches Won:</strong> ${mw}/${mp} (${mPct}%)</div>
    `;
    elStatsDisplay.innerHTML = html;
    elInfoOverlay.style.display = 'flex'; 
}
function closeInfo() { elInfoOverlay.style.display = 'none'; }

// --- SERVICE WORKER REGISTRATION ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW Registered', reg))
        .catch(err => console.log('SW Error', err));
    });
}

resetGame();

</script>
</body>
</html>